/**
 * 취약점 관리 API 클라이언트
 * SBOM 기반 보안 취약점 경고 시스템
 */

import apiClient from '../../utils/apiClient';
import type { ApiResponse } from '../../types';
import type {
  VulnerabilityAlert,
  VulnerabilitySummary,
  VulnerabilityScanResult,
  VulnerabilityCheckResponse,
  VulnerabilityException,
  VulnerabilityScanRequest,
  VulnerabilityIgnoreRequest,
  VulnerabilityExceptionRequest,
  CombinedVulnerabilitiesResponse,
} from '../../types/vulnerability';

const BASE_PATH = '/vuln';

/**
 * 취약점 API 클라이언트
 */
export const vulnerabilityApi = {
  /**
   * SBOM 취약점 조회
   * @param sbomId SBOM ID
   * @param severity 심각도 필터 (all, critical, high)
   * @param status 상태 필터 (all, open, ignored, resolved)
   */
  checkVulnerabilities: async (
    sbomId: number,
    severity: string = 'all',
    status: string = 'all'
  ): Promise<ApiResponse<VulnerabilityCheckResponse>> => {
    const params = new URLSearchParams();
    if (severity !== 'all') params.append('severity', severity);
    if (status !== 'all') params.append('status', status);

    const queryString = params.toString();
    const url = `${BASE_PATH}/check/${sbomId}${queryString ? `?${queryString}` : ''}`;

    return apiClient.get<VulnerabilityCheckResponse>(url);
  },

  /**
   * 서비스 취약점 요약 조회
   * @param serviceId 서비스 ID
   */
  getServiceSummary: async (
    serviceId: number
  ): Promise<ApiResponse<VulnerabilitySummary>> => {
    return apiClient.get<VulnerabilitySummary>(`${BASE_PATH}/summary/${serviceId}`);
  },

  /**
   * 통합 취약점 조회 (OSV API + SCA Trivy 또는 SAST)
   * @param serviceId 서비스 ID
   * @param severity 심각도 필터 (all, critical, high)
   * @param image 이미지 필터 (선택)
   * @param sourceType 데이터 소스 타입 (sca: Trivy+OSV, sast: Semgrep/CodeQL+OSV, all: 모두)
   */
  getCombinedVulnerabilities: async (
    serviceId: number,
    severity: string = 'all',
    image?: string,
    sourceType: 'sca' | 'sast' | 'all' = 'all'
  ): Promise<ApiResponse<CombinedVulnerabilitiesResponse>> => {
    const params = new URLSearchParams();
    if (severity !== 'all') params.append('severity', severity);
    if (image) params.append('image', image);
    if (sourceType !== 'all') params.append('source_type', sourceType);

    const queryString = params.toString();
    const url = `${BASE_PATH}/combined/${serviceId}${queryString ? `?${queryString}` : ''}`;

    return apiClient.get<CombinedVulnerabilitiesResponse>(url);
  },

  /**
   * 취약점 스캔 실행
   * @param request 스캔 요청
   */
  scanVulnerabilities: async (
    request: VulnerabilityScanRequest
  ): Promise<ApiResponse<VulnerabilityScanResult>> => {
    return apiClient.post<VulnerabilityScanRequest, VulnerabilityScanResult>(
      `${BASE_PATH}/scan`,
      request
    );
  },

  /**
   * 취약점 재스캔 (캐시 무시)
   * @param sbomId SBOM ID
   * @param serviceId 서비스 ID (선택)
   */
  rescanVulnerabilities: async (
    sbomId: number,
    serviceId?: number
  ): Promise<ApiResponse<VulnerabilityScanResult>> => {
    const params = serviceId ? `?service_id=${serviceId}` : '';
    return apiClient.post<Record<string, never>, VulnerabilityScanResult>(
      `${BASE_PATH}/rescan/${sbomId}${params}`,
      {}
    );
  },

  /**
   * 취약점 무시 처리
   * @param request 무시 요청
   */
  ignoreVulnerability: async (
    request: VulnerabilityIgnoreRequest
  ): Promise<ApiResponse<{ message: string }>> => {
    return apiClient.post<VulnerabilityIgnoreRequest, { message: string }>(
      `${BASE_PATH}/ignore`,
      request
    );
  },

  /**
   * 취약점 무시 해제
   * @param alertId 경고 ID
   */
  unignoreVulnerability: async (
    alertId: number
  ): Promise<ApiResponse<{ message: string }>> => {
    return apiClient.delete<{ message: string }>(`${BASE_PATH}/ignore/${alertId}`);
  },

  /**
   * 무시된 취약점 목록 조회
   * @param serviceId 서비스 ID
   */
  getIgnoredVulnerabilities: async (
    serviceId: number
  ): Promise<ApiResponse<VulnerabilityAlert[]>> => {
    return apiClient.get<VulnerabilityAlert[]>(`${BASE_PATH}/ignored/${serviceId}`);
  },

  /**
   * 예외 규칙 생성
   * @param request 예외 생성 요청
   */
  createException: async (
    request: VulnerabilityExceptionRequest
  ): Promise<ApiResponse<{ exception_id: number; message: string }>> => {
    return apiClient.post<
      VulnerabilityExceptionRequest,
      { exception_id: number; message: string }
    >(`${BASE_PATH}/exception`, request);
  },

  /**
   * 예외 규칙 목록 조회
   * @param serviceId 서비스 ID (선택)
   */
  getExceptions: async (
    serviceId?: number
  ): Promise<ApiResponse<VulnerabilityException[]>> => {
    const params = serviceId ? `?service_id=${serviceId}` : '';
    return apiClient.get<VulnerabilityException[]>(`${BASE_PATH}/exceptions${params}`);
  },

  /**
   * 예외 규칙 삭제
   * @param exceptionId 예외 ID
   */
  deleteException: async (
    exceptionId: number
  ): Promise<ApiResponse<{ message: string }>> => {
    return apiClient.delete<{ message: string }>(`${BASE_PATH}/exception/${exceptionId}`);
  },
};

export default vulnerabilityApi;
