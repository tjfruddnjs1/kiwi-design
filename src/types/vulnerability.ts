/**
 * 취약점 관련 타입 정의
 * SBOM 기반 보안 취약점 경고 시스템
 */

// 취약점 심각도
export type VulnerabilitySeverity = 'critical' | 'high' | 'medium' | 'low';

// 취약점 상태
export type VulnerabilityStatus = 'open' | 'ignored' | 'resolved';

// 예외 스코프
export type ExceptionScope = 'global' | 'service' | 'sbom';

// 예외 타입
export type ExceptionType = 'cve' | 'component' | 'purl';

/**
 * 취약점 경고 정보
 */
export interface VulnerabilityAlert {
  id: number;
  sbom_id: number;
  service_id: number;
  component_name: string;
  component_version: string;
  purl: string;
  package_type: string;
  cve_id: string;
  cvss_score: number;
  cvss_version: string;
  severity: VulnerabilitySeverity;
  title: string;
  description: string;
  cwe_ids: string;
  references: string; // JSON array of URLs
  published_at: string | null;
  modified_at: string | null;
  fixed_version: string | null;
  patch_available: boolean;
  upgrade_command: string | null;
  status: VulnerabilityStatus;
  ignored_reason?: string;
  ignored_by?: string;
  ignored_at?: string;
  resolved_at?: string;
  resolved_version?: string;
  data_source: string;
  source_id: string;
  created_at: string;
  updated_at: string;
}

/**
 * 서비스 취약점 요약
 */
export interface VulnerabilitySummary {
  service_id: number;
  sbom_count: number;
  total_vulnerabilities: number;
  open_critical: number;
  open_high: number;
  open_total: number;
  ignored_total: number;
  resolved_total: number;
  patchable_count: number;
  max_cvss_score: number;
  last_scan_at: string | null;
}

/**
 * 취약점 스캔 결과
 */
export interface VulnerabilityScanResult {
  sbom_id: number;
  service_id: number;
  total_components: number;
  scanned_components: number;
  total_vulnerabilities: number;
  critical_count: number;
  high_count: number;
  medium_count: number;
  low_count: number;
  alerts: VulnerabilityAlert[];
  scan_duration: string;
}

/**
 * 취약점 예외 규칙
 */
export interface VulnerabilityException {
  id: number;
  scope: ExceptionScope;
  service_id?: number;
  sbom_id?: number;
  exception_type: ExceptionType;
  cve_id?: string;
  component_name?: string;
  component_version?: string;
  purl_pattern?: string;
  reason: string;
  justification?: string;
  expires_at?: string;
  created_by?: string;
  approved_by?: string;
  approved_at?: string;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

/**
 * 취약점 조회 응답
 */
export interface VulnerabilityCheckResponse {
  sbom_id: number;
  alerts: VulnerabilityAlert[];
  total_vulnerabilities: number;
  critical_count: number;
  high_count: number;
  medium_count: number;
  low_count: number;
  open_count: number;
  patchable_count: number;
}

/**
 * 스캔 요청
 */
export interface VulnerabilityScanRequest {
  sbom_id: number;
  service_id: number;
  force_refresh?: boolean;
}

/**
 * 무시 요청
 */
export interface VulnerabilityIgnoreRequest {
  alert_id: number;
  reason: string;
}

/**
 * 예외 생성 요청
 */
export interface VulnerabilityExceptionRequest {
  scope: ExceptionScope;
  service_id?: number;
  sbom_id?: number;
  exception_type: ExceptionType;
  cve_id?: string;
  component_name?: string;
  component_version?: string;
  purl_pattern?: string;
  reason: string;
  justification?: string;
  expires_at?: string;
}

// ==================== 통합 취약점 타입 (OSV + SCA) ====================

/**
 * 데이터 소스 정보
 */
export interface DataSourceInfo {
  source: 'osv' | 'trivy' | 'semgrep' | 'codeql';
  source_name: string;
  vuln_count: number;
  last_scan_at: string;
  is_cached: boolean;
  cache_age?: string;
}

/**
 * 통합 취약점 항목
 */
export interface CombinedVulnerability {
  id?: number;
  cve_id: string;
  component_name: string;
  component_version: string;
  severity: VulnerabilitySeverity;
  cvss_score: number;
  title: string;
  description: string;
  fixed_version?: string;
  patch_available: boolean;
  references?: string;
  data_source: 'osv' | 'trivy' | 'semgrep' | 'codeql';
  source_tool: string;
  last_scanned_at: string;
  status: VulnerabilityStatus;
}

/**
 * 통합 취약점 응답
 */
export interface CombinedVulnerabilitiesResponse {
  service_id: number;
  total_vulnerabilities: number;
  critical_count: number;
  high_count: number;
  medium_count: number;
  low_count: number;
  vulnerabilities: CombinedVulnerability[];
  data_sources: DataSourceInfo[];
}

/**
 * 데이터 소스별 색상
 */
export const DATA_SOURCE_COLORS: Record<string, string> = {
  osv: '#1890ff',
  trivy: '#52c41a',
  semgrep: '#722ed1',
  codeql: '#3b82f6',
};

/**
 * 데이터 소스별 라벨
 */
export const DATA_SOURCE_LABELS: Record<string, string> = {
  osv: 'OSV API',
  trivy: 'Trivy SCA',
  semgrep: 'Semgrep SAST',
  codeql: 'CodeQL SAST',
};

// ==================== 상수 ====================

/**
 * 심각도별 색상
 */
export const SEVERITY_COLORS: Record<VulnerabilitySeverity, string> = {
  critical: '#cf1322',
  high: '#fa541c',
  medium: '#faad14',
  low: '#52c41a',
};

/**
 * 심각도별 배경색
 */
export const SEVERITY_BG_COLORS: Record<VulnerabilitySeverity, string> = {
  critical: '#fff1f0',
  high: '#fff2e8',
  medium: '#fffbe6',
  low: '#f6ffed',
};

/**
 * 심각도별 라벨
 */
export const SEVERITY_LABELS: Record<VulnerabilitySeverity, string> = {
  critical: 'Critical',
  high: 'High',
  medium: 'Medium',
  low: 'Low',
};

/**
 * 심각도별 한글 라벨
 */
export const SEVERITY_LABELS_KO: Record<VulnerabilitySeverity, string> = {
  critical: '심각',
  high: '높음',
  medium: '중간',
  low: '낮음',
};

/**
 * 상태별 색상
 */
export const STATUS_COLORS: Record<VulnerabilityStatus, string> = {
  open: '#fa541c',
  ignored: '#8c8c8c',
  resolved: '#52c41a',
};

/**
 * 상태별 라벨
 */
export const STATUS_LABELS: Record<VulnerabilityStatus, string> = {
  open: '미해결',
  ignored: '무시됨',
  resolved: '해결됨',
};

/**
 * CVSS 점수로 심각도 계산
 */
export function getSeverityFromCVSS(cvss: number): VulnerabilitySeverity {
  if (cvss >= 9.0) return 'critical';
  if (cvss >= 7.0) return 'high';
  if (cvss >= 4.0) return 'medium';
  return 'low';
}

/**
 * 심각도가 Critical 또는 High인지 확인
 */
export function isCriticalOrHigh(severity: VulnerabilitySeverity): boolean {
  return severity === 'critical' || severity === 'high';
}

/**
 * 참조 URL 배열 파싱
 */
export function parseReferences(refs: string): string[] {
  try {
    return JSON.parse(refs) || [];
  } catch {
    return [];
  }
}

/**
 * CWE ID 배열 파싱
 */
export function parseCWEIds(cweIds: string): string[] {
  if (!cweIds) return [];
  return cweIds.split(',').map(id => id.trim()).filter(Boolean);
}

/**
 * 패키지 타입별 아이콘 매핑
 */
export const PACKAGE_TYPE_ICONS: Record<string, string> = {
  npm: 'npm',
  pypi: 'python',
  maven: 'java',
  go: 'go',
  golang: 'go',
  nuget: 'dotnet',
  rubygems: 'ruby',
  packagist: 'php',
  cargo: 'rust',
};
