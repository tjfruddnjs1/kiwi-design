/**
 * CategorizedVulnerabilityView.tsx
 *
 * 카테고리화된 취약점 대시보드 컴포넌트
 * - 대시보드 스타일 요약 통계
 * - 심각도 기반 우선순위 표시
 * - 카테고리별 분포 시각화
 * - 간결한 카드 레이아웃
 */

import React, { useState, useEffect, useCallback } from 'react';
import {
  Card,
  Badge,
  Tag,
  Space,
  Typography,
  Switch,
  Spin,
  Alert,
  Empty,
  Row,
  Col,
  Progress,
  Tooltip,
  message,
  Segmented,
} from 'antd';
import {
  SafetyOutlined,
  CheckCircleOutlined,
  ExclamationCircleOutlined,
  FilterOutlined,
  BugOutlined,
  ThunderboltOutlined,
  WarningOutlined,
  InfoCircleOutlined,
} from '@ant-design/icons';
import { analysisApi } from '../../lib/api/analysis-client';
import { isAnalysisApiError } from '../../lib/api/analysis-client';
import VulnerabilityChecklistCard from './VulnerabilityChecklistCard';
import type {
  CategorizedScanResponse,
  CategorizedVulnerabilityGroup,
  ChecklistItemStatus,
  SeverityLevel,
} from '../../types/securityAnalysis';
import {
  categoryColors,
  VULNERABILITY_CATEGORIES,
  severityColors,
  SCA_CATEGORY_INFO,
} from '../../types/securityAnalysis';

const { Title, Text } = Typography;

/**
 * 안전한 날짜 포맷팅 함수
 * - null, undefined, 유효하지 않은 날짜 처리
 */
const formatSafeDate = (timestamp: string | null | undefined): string => {
  if (!timestamp) {
    return '정보 없음';
  }

  try {
    const date = new Date(timestamp);
    // Invalid Date 체크
    if (isNaN(date.getTime())) {
      return '정보 없음';
    }
    return date.toLocaleString('ko-KR');
  } catch {
    return '정보 없음';
  }
};

interface CategorizedVulnerabilityViewProps {
  repoId: number;
  onRefresh?: () => void;
  compact?: boolean;
  /**
   * 분석 유형: 'sast' | 'sca' | 'dast' | 'all'
   * - sast: 정적 코드 분석 (INJ, AUTH 등 카테고리)
   * - sca: 이미지/패키지 분석 (CVE_CRITICAL, CVE_HIGH 등 카테고리)
   * - dast: 동적 웹 분석
   * - all: 모든 분석 결과 통합 (기본값)
   */
  analysisType?: 'sast' | 'sca' | 'dast' | 'all';
  /**
   * 선택된 이미지 이름 (SCA의 경우 특정 이미지의 취약점만 필터링)
   */
  selectedImageName?: string | null;
}

/**
 * 심각도별 아이콘
 */
const SeverityIcon: React.FC<{ severity: SeverityLevel }> = ({ severity }) => {
  const icons: Record<SeverityLevel, React.ReactNode> = {
    critical: (
      <ThunderboltOutlined style={{ color: severityColors.critical }} />
    ),
    high: <ExclamationCircleOutlined style={{ color: severityColors.high }} />,
    medium: <WarningOutlined style={{ color: severityColors.medium }} />,
    low: <InfoCircleOutlined style={{ color: severityColors.low }} />,
    info: <InfoCircleOutlined style={{ color: severityColors.info }} />,
  };
  return <>{icons[severity]}</>;
};

/**
 * 심각도 통계 카드 컴포넌트
 */
const SeverityStatCard: React.FC<{
  severity: SeverityLevel;
  count: number;
  total: number;
}> = ({ severity, count, total }) => {
  const labels: Record<SeverityLevel, string> = {
    critical: 'Critical',
    high: 'High',
    medium: 'Medium',
    low: 'Low',
    info: 'Info',
  };

  const percent = total > 0 ? Math.round((count / total) * 100) : 0;

  return (
    <Card
      size='small'
      style={{
        borderRadius: 12,
        border: `1px solid ${severityColors[severity]}20`,
        background: `linear-gradient(135deg, ${severityColors[severity]}08 0%, ${severityColors[severity]}15 100%)`,
      }}
      styles={{ body: { padding: '16px' } }}
    >
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        }}
      >
        <div>
          <div
            style={{
              display: 'flex',
              alignItems: 'center',
              gap: 8,
              marginBottom: 4,
            }}
          >
            <SeverityIcon severity={severity} />
            <Text style={{ fontSize: 13, fontWeight: 500, color: '#666' }}>
              {labels[severity]}
            </Text>
          </div>
          <div
            style={{
              fontSize: 28,
              fontWeight: 700,
              color: severityColors[severity],
            }}
          >
            {count}
          </div>
        </div>
        <div style={{ width: 50, height: 50 }}>
          <Progress
            type='circle'
            percent={percent}
            size={50}
            strokeColor={severityColors[severity]}
            strokeWidth={8}
            format={() => (
              <span style={{ fontSize: 11, color: '#999' }}>{percent}%</span>
            )}
          />
        </div>
      </div>
    </Card>
  );
};

/**
 * 해결 진행률 카드
 */
const ResolutionProgressCard: React.FC<{
  total: number;
  resolved: number;
  open: number;
}> = ({ total, resolved, open }) => {
  const percent = total > 0 ? Math.round((resolved / total) * 100) : 0;

  return (
    <Card
      size='small'
      style={{
        borderRadius: 12,
        background: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)',
        border: '1px solid #bae6fd',
      }}
      styles={{ body: { padding: '20px' } }}
    >
      <Row gutter={24} align='middle'>
        <Col flex='1'>
          <div style={{ marginBottom: 12 }}>
            <Text strong style={{ fontSize: 16 }}>
              해결 진행률
            </Text>
          </div>
          <Progress
            percent={percent}
            strokeColor={{
              '0%': '#3b82f6',
              '100%': '#10b981',
            }}
            strokeWidth={12}
            style={{ marginBottom: 8 }}
          />
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <Space>
              <Badge color='#10b981' />
              <Text type='secondary' style={{ fontSize: 12 }}>
                해결됨: {resolved}
              </Text>
            </Space>
            <Space>
              <Badge color='#ef4444' />
              <Text type='secondary' style={{ fontSize: 12 }}>
                미해결: {open}
              </Text>
            </Space>
          </div>
        </Col>
        <Col>
          <div style={{ textAlign: 'center' }}>
            <div
              style={{
                fontSize: 36,
                fontWeight: 700,
                color: percent === 100 ? '#10b981' : '#3b82f6',
              }}
            >
              {percent}%
            </div>
            <Text type='secondary' style={{ fontSize: 12 }}>
              완료
            </Text>
          </div>
        </Col>
      </Row>
    </Card>
  );
};

/**
 * SCA 카테고리 Tooltip 내용 렌더링
 */
const renderScaCategoryTooltip = (categoryId: string) => {
  const info = SCA_CATEGORY_INFO[categoryId];
  if (!info) return null;

  return (
    <div style={{ maxWidth: 280, padding: 4 }}>
      <div style={{ marginBottom: 8 }}>
        <Text strong style={{ color: '#fff', fontSize: 14 }}>
          {info.icon} {info.label} 위험도
        </Text>
        <Tag
          style={{
            marginLeft: 8,
            fontSize: 11,
            background: info.bgColor,
            color: info.color,
            border: 'none',
          }}
        >
          {info.cvssRange}
        </Tag>
      </div>
      <div
        style={{
          marginBottom: 8,
          color: 'rgba(255,255,255,0.9)',
          fontSize: 12,
        }}
      >
        {info.description}
      </div>
      <div
        style={{
          background: 'rgba(255,255,255,0.1)',
          borderRadius: 4,
          padding: '6px 8px',
          marginBottom: 8,
        }}
      >
        <Text style={{ color: '#ffd666', fontSize: 11, fontWeight: 500 }}>
          ⏰ {info.actionTimeframe}
        </Text>
      </div>
      <div
        style={{
          color: 'rgba(255,255,255,0.8)',
          fontSize: 11,
          whiteSpace: 'pre-line',
        }}
      >
        {info.guidance}
      </div>
    </div>
  );
};

/**
 * 카테고리 미니 카드
 */
const CategoryMiniCard: React.FC<{
  category: CategorizedVulnerabilityGroup;
  isSelected: boolean;
  onClick: () => void;
}> = ({ category, isSelected, onClick }) => {
  const hasIssues = category.total_count > 0;
  const hasOpen = category.open_count > 0;
  const isScaCategory = category.category_id.startsWith('CVE_');
  const scaInfo = isScaCategory
    ? SCA_CATEGORY_INFO[category.category_id]
    : null;

  const cardContent = (
    <Card
      size='small'
      hoverable
      onClick={onClick}
      style={{
        borderRadius: 10,
        cursor: 'pointer',
        border: isSelected
          ? `2px solid ${categoryColors[category.category_id]}`
          : '1px solid #e5e7eb',
        background: isSelected
          ? `${categoryColors[category.category_id]}08`
          : isScaCategory && scaInfo
            ? scaInfo.bgColor
            : hasIssues
              ? '#fff'
              : '#fafafa',
        opacity: hasIssues ? 1 : 0.6,
      }}
      styles={{ body: { padding: '12px 16px' } }}
    >
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
        }}
      >
        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
          {isScaCategory && scaInfo && (
            <span style={{ fontSize: 16 }}>{scaInfo.icon}</span>
          )}
          <Tag
            color={categoryColors[category.category_id]}
            style={{
              fontWeight: 600,
              fontSize: 11,
              margin: 0,
              borderRadius: 4,
            }}
          >
            {isScaCategory && scaInfo ? scaInfo.label : category.category_id}
          </Tag>
          <div>
            <Text strong style={{ fontSize: 13 }}>
              {category.category_name_ko}
            </Text>
            {isScaCategory && scaInfo && (
              <div style={{ fontSize: 10, color: '#666', marginTop: 2 }}>
                {scaInfo.cvssRange} · {scaInfo.actionTimeframe}
              </div>
            )}
          </div>
        </div>
        <div style={{ display: 'flex', alignItems: 'center', gap: 6 }}>
          {hasOpen && (
            <Badge
              count={category.open_count}
              style={{ backgroundColor: '#ef4444', fontSize: 10 }}
            />
          )}
          {category.resolved_count > 0 && (
            <Badge
              count={category.resolved_count}
              style={{ backgroundColor: '#10b981', fontSize: 10 }}
            />
          )}
          {!hasIssues && (
            <CheckCircleOutlined style={{ color: '#10b981', fontSize: 16 }} />
          )}
        </div>
      </div>
    </Card>
  );

  // SCA 카테고리는 Tooltip으로 상세 정보 표시
  if (isScaCategory) {
    return (
      <Tooltip
        title={renderScaCategoryTooltip(category.category_id)}
        placement='right'
        color='#1f1f1f'
      >
        {cardContent}
      </Tooltip>
    );
  }

  return cardContent;
};

export const CategorizedVulnerabilityView: React.FC<
  CategorizedVulnerabilityViewProps
> = ({
  repoId,
  onRefresh,
  compact = false,
  analysisType = 'all',
  selectedImageName,
}) => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<CategorizedScanResponse | null>(null);
  const [showPendingOnly, setShowPendingOnly] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState<string | null>(null);
  const [severityFilter, setSeverityFilter] = useState<SeverityLevel | 'all'>(
    'all'
  );
  const [isUpdating, setIsUpdating] = useState(false);

  /**
   * 카테고리화된 취약점 데이터 로드
   */
  const fetchData = useCallback(async () => {
    setLoading(true);
    setError(null);

    try {
      const response = showPendingOnly
        ? await analysisApi.getPendingVulnerabilities(
            repoId,
            analysisType,
            selectedImageName
          )
        : await analysisApi.getCategorizedVulnerabilities(
            repoId,
            analysisType,
            selectedImageName
          );

      if (response.data) {
        setData(response.data as CategorizedScanResponse);

        // 첫 번째로 미해결 항목이 있는 카테고리 선택
        const firstWithOpen = response.data.categories.find(
          (cat: CategorizedVulnerabilityGroup) => cat.open_count > 0
        );
        if (firstWithOpen) {
          setSelectedCategory(firstWithOpen.category_id);
        } else if (response.data.categories.length > 0) {
          setSelectedCategory(response.data.categories[0].category_id);
        }
      }
    } catch (err) {
      if (isAnalysisApiError(err)) {
        setError(err.message);
      } else {
        setError('취약점 데이터를 불러오는 중 오류가 발생했습니다.');
      }
    } finally {
      setLoading(false);
    }
  }, [repoId, showPendingOnly, analysisType, selectedImageName]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  /**
   * 취약점 상태 변경 핸들러
   */
  const handleStatusChange = async (
    itemId: string,
    newStatus: ChecklistItemStatus
  ) => {
    setIsUpdating(true);

    try {
      await analysisApi.resolveVulnerability({
        service_id: repoId,
        item_id: itemId,
        status: newStatus,
      });

      message.success(
        newStatus === 'open'
          ? '미해결로 되돌렸습니다.'
          : '상태가 업데이트되었습니다.'
      );

      await fetchData();
      onRefresh?.();
    } catch (err) {
      if (isAnalysisApiError(err)) {
        message.error(err.message);
      } else {
        message.error('상태 업데이트에 실패했습니다.');
      }
    } finally {
      setIsUpdating(false);
    }
  };

  /**
   * 필터 토글 핸들러
   */
  const handleFilterToggle = (checked: boolean) => {
    setShowPendingOnly(checked);
  };

  if (loading) {
    return (
      <div style={{ textAlign: 'center', padding: '60px' }}>
        <Spin size='large' />
        <div style={{ marginTop: 16, color: '#666' }}>
          취약점 데이터를 불러오는 중...
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <Alert
        type='error'
        message='데이터 로드 실패'
        description={error}
        showIcon
        action={<a onClick={fetchData}>다시 시도</a>}
      />
    );
  }

  if (!data || data.categories.length === 0) {
    return (
      <Empty
        image={Empty.PRESENTED_IMAGE_SIMPLE}
        description={
          <span>
            {showPendingOnly
              ? '미해결 취약점이 없습니다.'
              : '분석된 취약점이 없습니다.'}
          </span>
        }
      />
    );
  }

  const summary = data.summary;
  const totalOpen = summary.by_status?.open ?? summary.total_vulnerabilities;
  const totalResolved = summary.by_status?.resolved ?? 0;
  const total = summary.total_vulnerabilities;

  // 선택된 카테고리 데이터
  const selectedCategoryData = data.categories.find(
    cat => cat.category_id === selectedCategory
  );

  // 심각도 필터링된 아이템
  const filteredItems =
    selectedCategoryData?.checklist_items.filter(item => {
      if (showPendingOnly && item.status !== 'open') return false;
      if (severityFilter !== 'all' && item.severity !== severityFilter)
        return false;
      return true;
    }) || [];

  // 카테고리 필터링
  const filteredCategories = data.categories.filter(
    category => !showPendingOnly || category.open_count > 0
  );

  // SCA 분석 여부 확인
  const isScaAnalysis = analysisType === 'sca';

  return (
    <div style={{ padding: compact ? 0 : '8px' }}>
      {/* SCA 분석일 때 CVE 위험도 안내 배너 */}
      {isScaAnalysis && !compact && (
        <Alert
          type='info'
          showIcon
          icon={<InfoCircleOutlined />}
          style={{ marginBottom: 16, borderRadius: 8 }}
          message={
            <span style={{ fontWeight: 600 }}>
              컨테이너 이미지 취약점 분석 (SCA)
            </span>
          }
          description={
            <div style={{ marginTop: 8 }}>
              <div style={{ marginBottom: 8, color: '#666' }}>
                CVE(Common Vulnerabilities and Exposures)는 공개적으로 알려진
                보안 취약점 식별자입니다. CVSS 점수에 따라 위험도가 분류됩니다.
              </div>
              <Row gutter={[8, 8]}>
                {Object.values(SCA_CATEGORY_INFO).map(info => (
                  <Col xs={12} sm={6} key={info.id}>
                    <div
                      style={{
                        background: info.bgColor,
                        padding: '8px 12px',
                        borderRadius: 6,
                        border: `1px solid ${info.color}20`,
                      }}
                    >
                      <div
                        style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: 6,
                          marginBottom: 4,
                        }}
                      >
                        <span>{info.icon}</span>
                        <Text
                          strong
                          style={{ color: info.color, fontSize: 13 }}
                        >
                          {info.label}
                        </Text>
                      </div>
                      <div style={{ fontSize: 11, color: '#666' }}>
                        {info.cvssRange}
                      </div>
                      <div
                        style={{ fontSize: 10, color: '#888', marginTop: 2 }}
                      >
                        {info.actionTimeframe}
                      </div>
                    </div>
                  </Col>
                ))}
              </Row>
            </div>
          }
        />
      )}

      {/* 대시보드 요약 섹션 */}
      {!compact && (
        <div style={{ marginBottom: 24 }}>
          {/* 심각도별 통계 */}
          <Row gutter={[12, 12]} style={{ marginBottom: 16 }}>
            {(['critical', 'high', 'medium', 'low'] as SeverityLevel[]).map(
              severity => (
                <Col xs={12} sm={6} key={severity}>
                  <SeverityStatCard
                    severity={severity}
                    count={summary.by_severity[severity] || 0}
                    total={total}
                  />
                </Col>
              )
            )}
          </Row>

          {/* 해결 진행률 */}
          <ResolutionProgressCard
            total={total}
            resolved={totalResolved}
            open={totalOpen}
          />
        </div>
      )}

      {/* 필터 및 컨트롤 */}
      <Card
        size='small'
        style={{ marginBottom: 16, borderRadius: 10 }}
        styles={{ body: { padding: '12px 16px' } }}
      >
        <div
          style={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            flexWrap: 'wrap',
            gap: 12,
          }}
        >
          <Space size='middle'>
            <Space>
              <FilterOutlined style={{ color: '#666' }} />
              <Text>미해결만</Text>
              <Switch
                checked={showPendingOnly}
                onChange={handleFilterToggle}
                size='small'
              />
            </Space>
            <Segmented
              value={severityFilter}
              onChange={value =>
                setSeverityFilter(value as SeverityLevel | 'all')
              }
              options={[
                { label: '전체', value: 'all' },
                {
                  label: (
                    <Tag color={severityColors.critical} style={{ margin: 0 }}>
                      Critical
                    </Tag>
                  ),
                  value: 'critical',
                },
                {
                  label: (
                    <Tag color={severityColors.high} style={{ margin: 0 }}>
                      High
                    </Tag>
                  ),
                  value: 'high',
                },
                {
                  label: (
                    <Tag color={severityColors.medium} style={{ margin: 0 }}>
                      Medium
                    </Tag>
                  ),
                  value: 'medium',
                },
                {
                  label: (
                    <Tag color={severityColors.low} style={{ margin: 0 }}>
                      Low
                    </Tag>
                  ),
                  value: 'low',
                },
              ]}
              size='small'
            />
          </Space>
          <Text type='secondary' style={{ fontSize: 12 }}>
            마지막 스캔:{' '}
            {formatSafeDate(data.timestamp || (data as any).generated_at)}
          </Text>
        </div>
      </Card>

      {/* 카테고리 그리드 + 상세 목록 */}
      <Row gutter={16}>
        {/* 왼쪽: 카테고리 목록 */}
        <Col xs={24} lg={8}>
          <Card
            title={
              <Space>
                <SafetyOutlined />
                <span>카테고리 ({filteredCategories.length})</span>
              </Space>
            }
            size='small'
            style={{ borderRadius: 10, marginBottom: 16 }}
            styles={{ body: { padding: 12, maxHeight: 500, overflow: 'auto' } }}
          >
            <Space direction='vertical' style={{ width: '100%' }} size={8}>
              {filteredCategories.map(category => (
                <CategoryMiniCard
                  key={category.category_id}
                  category={category}
                  isSelected={selectedCategory === category.category_id}
                  onClick={() => setSelectedCategory(category.category_id)}
                />
              ))}
            </Space>
          </Card>
        </Col>

        {/* 오른쪽: 선택된 카테고리 상세 */}
        <Col xs={24} lg={16}>
          {selectedCategoryData ? (
            <Card
              title={
                <div
                  style={{
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'space-between',
                  }}
                >
                  <Space>
                    <Tag
                      color={categoryColors[selectedCategoryData.category_id]}
                      style={{ fontWeight: 600, fontSize: 12 }}
                    >
                      {selectedCategoryData.category_id}
                    </Tag>
                    <span style={{ fontWeight: 600 }}>
                      {selectedCategoryData.category_name_ko}
                    </span>
                    <Text type='secondary' style={{ fontSize: 12 }}>
                      ({selectedCategoryData.category_name})
                    </Text>
                  </Space>
                  <Space size={4}>
                    {selectedCategoryData.open_count > 0 && (
                      <Tag color='error'>
                        미해결 {selectedCategoryData.open_count}
                      </Tag>
                    )}
                    {selectedCategoryData.resolved_count > 0 && (
                      <Tag color='success'>
                        해결 {selectedCategoryData.resolved_count}
                      </Tag>
                    )}
                  </Space>
                </div>
              }
              size='small'
              style={{ borderRadius: 10 }}
              styles={{
                body: { padding: 12, maxHeight: 500, overflow: 'auto' },
              }}
              extra={
                <Tooltip
                  title={
                    VULNERABILITY_CATEGORIES[selectedCategoryData.category_id]
                      ?.description
                  }
                >
                  <InfoCircleOutlined style={{ color: '#999' }} />
                </Tooltip>
              }
            >
              {filteredItems.length === 0 ? (
                <Empty
                  image={Empty.PRESENTED_IMAGE_SIMPLE}
                  description={
                    severityFilter !== 'all'
                      ? `${severityFilter.toUpperCase()} 심각도의 취약점이 없습니다.`
                      : showPendingOnly
                        ? '미해결 취약점이 없습니다.'
                        : '취약점이 없습니다.'
                  }
                  style={{ padding: '40px 0' }}
                />
              ) : (
                <div>
                  {filteredItems.map(item => (
                    <VulnerabilityChecklistCard
                      key={item.item_id}
                      item={item}
                      onStatusChange={handleStatusChange}
                      loading={isUpdating}
                      compact={true}
                    />
                  ))}
                </div>
              )}
            </Card>
          ) : (
            <Card
              size='small'
              style={{ borderRadius: 10, textAlign: 'center', padding: 40 }}
            >
              <BugOutlined
                style={{ fontSize: 48, color: '#d9d9d9', marginBottom: 16 }}
              />
              <div>
                <Text type='secondary'>카테고리를 선택하세요</Text>
              </div>
            </Card>
          )}
        </Col>
      </Row>
    </div>
  );
};

export default CategorizedVulnerabilityView;
