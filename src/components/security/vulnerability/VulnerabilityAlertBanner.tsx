/**
 * Vulnerability Alert Banner
 *
 * Critical/High 취약점 존재 시 경고 배너를 표시하는 컴포넌트
 * - 심각도별 취약점 수 표시
 * - 패치 가능한 취약점 수 표시
 * - 상세 보기 링크
 */

import React from 'react';
import { Alert, Space, Tag, Button, Typography, Tooltip, Progress } from 'antd';
import {
  WarningOutlined,
  ExclamationCircleOutlined,
  CheckCircleOutlined,
  SafetyOutlined,
  ArrowRightOutlined,
  SyncOutlined,
} from '@ant-design/icons';
import type { VulnerabilitySummary, VulnerabilityCheckResponse } from '../../../types/vulnerability';
import {
  SEVERITY_COLORS,
  SEVERITY_LABELS_KO,
} from '../../../types/vulnerability';

const { Text } = Typography;

interface VulnerabilityAlertBannerProps {
  summary?: VulnerabilitySummary | VulnerabilityCheckResponse | null;
  loading?: boolean;
  onViewDetails?: () => void;
  onRescan?: () => void;
  compact?: boolean;
}

export const VulnerabilityAlertBanner: React.FC<VulnerabilityAlertBannerProps> = ({
  summary,
  loading = false,
  onViewDetails,
  onRescan,
  compact = false,
}) => {
  // 데이터 정규화 (VulnerabilitySummary와 VulnerabilityCheckResponse 모두 지원)
  const criticalCount = (summary as VulnerabilitySummary)?.open_critical ??
                        (summary as VulnerabilityCheckResponse)?.critical_count ?? 0;
  const highCount = (summary as VulnerabilitySummary)?.open_high ??
                    (summary as VulnerabilityCheckResponse)?.high_count ?? 0;
  const totalCount = summary?.total_vulnerabilities ?? 0;
  const patchableCount = (summary as VulnerabilitySummary)?.patchable_count ??
                         (summary as VulnerabilityCheckResponse)?.patchable_count ?? 0;

  // 취약점이 없으면 안전 배너 표시
  if (!loading && totalCount === 0) {
    return (
      <Alert
        message={
          <Space>
            <SafetyOutlined style={{ color: '#52c41a' }} />
            <Text strong>보안 취약점이 발견되지 않았습니다</Text>
          </Space>
        }
        type="success"
        showIcon={false}
        style={{ marginBottom: 16 }}
      />
    );
  }

  // Critical 또는 High가 없으면 정보성 배너
  if (!loading && criticalCount === 0 && highCount === 0) {
    return (
      <Alert
        message={
          <Space size="middle" wrap>
            <Space>
              <CheckCircleOutlined style={{ color: '#52c41a' }} />
              <Text>심각한 취약점이 없습니다</Text>
            </Space>
            {totalCount > 0 && (
              <Text type="secondary">
                (Medium/Low {totalCount}건)
              </Text>
            )}
            {onViewDetails && (
              <Button type="link" size="small" onClick={onViewDetails}>
                상세 보기 <ArrowRightOutlined />
              </Button>
            )}
          </Space>
        }
        type="info"
        showIcon={false}
        style={{ marginBottom: 16 }}
      />
    );
  }

  // Critical/High 취약점이 있으면 경고 배너
  const hasCritical = criticalCount > 0;
  const alertType = hasCritical ? 'error' : 'warning';
  const alertIcon = hasCritical ? <ExclamationCircleOutlined /> : <WarningOutlined />;

  // 패치 가능 비율 계산
  const criticalHighTotal = criticalCount + highCount;
  const patchablePercent = criticalHighTotal > 0
    ? Math.round((patchableCount / criticalHighTotal) * 100)
    : 0;

  if (compact) {
    return (
      <Alert
        message={
          <Space size="middle">
            {criticalCount > 0 && (
              <Tag color={SEVERITY_COLORS.critical}>
                Critical {criticalCount}
              </Tag>
            )}
            {highCount > 0 && (
              <Tag color={SEVERITY_COLORS.high}>
                High {highCount}
              </Tag>
            )}
            {patchableCount > 0 && (
              <Tooltip title="패치 가능한 취약점">
                <Tag color="blue">{patchableCount}건 패치 가능</Tag>
              </Tooltip>
            )}
            {onViewDetails && (
              <Button type="link" size="small" onClick={onViewDetails}>
                상세 보기
              </Button>
            )}
          </Space>
        }
        type={alertType}
        icon={alertIcon}
        showIcon
        style={{ marginBottom: 16 }}
      />
    );
  }

  return (
    <Alert
      message={
        <Space direction="vertical" size={8} style={{ width: '100%' }}>
          <Space size="middle" wrap style={{ justifyContent: 'space-between', width: '100%' }}>
            <Space size="middle">
              <Text strong style={{ fontSize: 14 }}>
                {hasCritical ? '심각한 보안 취약점 발견' : '보안 취약점 발견'}
              </Text>
              <Space size={4}>
                {criticalCount > 0 && (
                  <Tag color={SEVERITY_COLORS.critical} style={{ margin: 0 }}>
                    {SEVERITY_LABELS_KO.critical} {criticalCount}건
                  </Tag>
                )}
                {highCount > 0 && (
                  <Tag color={SEVERITY_COLORS.high} style={{ margin: 0 }}>
                    {SEVERITY_LABELS_KO.high} {highCount}건
                  </Tag>
                )}
              </Space>
            </Space>
            <Space>
              {onRescan && (
                <Tooltip title="취약점 재스캔">
                  <Button
                    size="small"
                    icon={<SyncOutlined spin={loading} />}
                    onClick={onRescan}
                    loading={loading}
                  >
                    재스캔
                  </Button>
                </Tooltip>
              )}
              {onViewDetails && (
                <Button type="primary" size="small" onClick={onViewDetails}>
                  상세 보기 <ArrowRightOutlined />
                </Button>
              )}
            </Space>
          </Space>

          {patchableCount > 0 && (
            <Space size="middle" style={{ marginTop: 4 }}>
              <Text type="secondary" style={{ fontSize: 12 }}>
                패치 가능: {patchableCount}건 ({patchablePercent}%)
              </Text>
              <Progress
                percent={patchablePercent}
                size="small"
                style={{ width: 120 }}
                strokeColor="#1890ff"
                showInfo={false}
              />
              <Text type="secondary" style={{ fontSize: 12 }}>
                라이브러리 업그레이드로 해결 가능
              </Text>
            </Space>
          )}
        </Space>
      }
      type={alertType}
      icon={alertIcon}
      showIcon
      style={{ marginBottom: 16 }}
    />
  );
};

export default VulnerabilityAlertBanner;
