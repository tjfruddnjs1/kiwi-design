/**
 * Vulnerability Table
 *
 * 취약점 목록을 테이블 형태로 표시하는 컴포넌트
 * - 심각도별 필터링
 * - 상태별 필터링
 * - 검색 기능
 * - 정렬 기능
 */

import React, { useState, useMemo } from 'react';
import {
  Table,
  Input,
  Select,
  Tag,
  Space,
  Typography,
  Tooltip,
  Button,
  Badge,
  message,
  Popover,
} from 'antd';
import {
  SearchOutlined,
  FilterOutlined,
  CopyOutlined,
  ExportOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  ExclamationCircleOutlined,
} from '@ant-design/icons';
import type { ColumnsType } from 'antd/es/table';
import type { VulnerabilityAlert, VulnerabilitySeverity, VulnerabilityStatus } from '../../../types/vulnerability';
import {
  SEVERITY_COLORS,
  SEVERITY_LABELS,
  SEVERITY_LABELS_KO,
  STATUS_COLORS,
  STATUS_LABELS,
  parseReferences,
  parseCWEIds,
} from '../../../types/vulnerability';

const { Text, Link } = Typography;

interface VulnerabilityTableProps {
  vulnerabilities: VulnerabilityAlert[];
  loading?: boolean;
  pageSize?: number;
  onIgnore?: (alert: VulnerabilityAlert) => void;
  onUnignore?: (alert: VulnerabilityAlert) => void;
  onViewDetail?: (alert: VulnerabilityAlert) => void;
  showOnlyCriticalHigh?: boolean;
}

/**
 * CVSS 점수 뱃지
 */
const CVSSBadge: React.FC<{ score: number; version?: string }> = ({ score, version }) => {
  let color = '#52c41a';
  if (score >= 9.0) color = SEVERITY_COLORS.critical;
  else if (score >= 7.0) color = SEVERITY_COLORS.high;
  else if (score >= 4.0) color = SEVERITY_COLORS.medium;

  return (
    <Tooltip title={`CVSS ${version || '3.1'}`}>
      <Tag
        color={color}
        style={{
          fontWeight: 'bold',
          minWidth: 40,
          textAlign: 'center',
        }}
      >
        {score.toFixed(1)}
      </Tag>
    </Tooltip>
  );
};

/**
 * 참조 URL 팝오버
 */
const ReferencesPopover: React.FC<{ references: string }> = ({ references }) => {
  const urls = parseReferences(references);
  if (urls.length === 0) return <Text type="secondary">-</Text>;

  const content = (
    <Space direction="vertical" size={4} style={{ maxWidth: 400, maxHeight: 200, overflow: 'auto' }}>
      {urls.slice(0, 10).map((url, idx) => (
        <Link key={idx} href={url} target="_blank" ellipsis style={{ maxWidth: 380 }}>
          {url}
        </Link>
      ))}
      {urls.length > 10 && (
        <Text type="secondary">외 {urls.length - 10}개</Text>
      )}
    </Space>
  );

  return (
    <Popover content={content} title="참조 URL" trigger="click">
      <Button type="link" size="small" icon={<ExportOutlined />}>
        {urls.length}개
      </Button>
    </Popover>
  );
};

export const VulnerabilityTable: React.FC<VulnerabilityTableProps> = ({
  vulnerabilities,
  loading = false,
  pageSize = 20,
  onIgnore,
  onUnignore,
  onViewDetail,
  showOnlyCriticalHigh = false,
}) => {
  const [searchText, setSearchText] = useState('');
  const [severityFilter, setSeverityFilter] = useState<VulnerabilitySeverity | 'all'>('all');
  const [statusFilter, setStatusFilter] = useState<VulnerabilityStatus | 'all'>('all');

  // 필터링된 데이터
  const filteredData = useMemo(() => {
    let result = vulnerabilities;

    // Critical/High만 표시
    if (showOnlyCriticalHigh) {
      result = result.filter(v => v.severity === 'critical' || v.severity === 'high');
    }

    // 검색어 필터
    if (searchText) {
      const search = searchText.toLowerCase();
      result = result.filter(v =>
        v.component_name?.toLowerCase().includes(search) ||
        v.cve_id?.toLowerCase().includes(search) ||
        v.title?.toLowerCase().includes(search) ||
        v.purl?.toLowerCase().includes(search)
      );
    }

    // 심각도 필터
    if (severityFilter !== 'all') {
      result = result.filter(v => v.severity === severityFilter);
    }

    // 상태 필터
    if (statusFilter !== 'all') {
      result = result.filter(v => v.status === statusFilter);
    }

    return result;
  }, [vulnerabilities, searchText, severityFilter, statusFilter, showOnlyCriticalHigh]);

  // 컬럼 정의
  const columns: ColumnsType<VulnerabilityAlert> = [
    {
      title: '심각도',
      dataIndex: 'severity',
      key: 'severity',
      width: 90,
      sorter: (a, b) => {
        const order = { critical: 4, high: 3, medium: 2, low: 1 };
        return order[b.severity] - order[a.severity];
      },
      defaultSortOrder: 'ascend',
      render: (severity: VulnerabilitySeverity) => (
        <Tag color={SEVERITY_COLORS[severity]} style={{ fontWeight: 'bold' }}>
          {SEVERITY_LABELS[severity]}
        </Tag>
      ),
    },
    {
      title: 'CVSS',
      dataIndex: 'cvss_score',
      key: 'cvss_score',
      width: 70,
      sorter: (a, b) => b.cvss_score - a.cvss_score,
      render: (score: number, record) => (
        <CVSSBadge score={score} version={record.cvss_version} />
      ),
    },
    {
      title: 'CVE ID',
      dataIndex: 'cve_id',
      key: 'cve_id',
      width: 150,
      render: (cveId: string) => {
        const isCVE = cveId?.startsWith('CVE-');
        const url = isCVE
          ? `https://nvd.nist.gov/vuln/detail/${cveId}`
          : `https://osv.dev/vulnerability/${cveId}`;

        return (
          <Space size={4}>
            <Link href={url} target="_blank">
              {cveId}
            </Link>
            <Tooltip title="복사">
              <Button
                type="text"
                size="small"
                icon={<CopyOutlined />}
                onClick={() => {
                  navigator.clipboard.writeText(cveId);
                  message.success('CVE ID가 복사되었습니다');
                }}
                style={{ padding: 0 }}
              />
            </Tooltip>
          </Space>
        );
      },
    },
    {
      title: '컴포넌트',
      key: 'component',
      width: 200,
      ellipsis: true,
      render: (_, record) => (
        <Space direction="vertical" size={0}>
          <Text strong ellipsis style={{ maxWidth: 180 }}>
            <Tooltip title={record.component_name}>
              {record.component_name}
            </Tooltip>
          </Text>
          <Text type="secondary" style={{ fontSize: 12 }}>
            {record.component_version || '-'}
          </Text>
        </Space>
      ),
    },
    {
      title: '취약점',
      dataIndex: 'title',
      key: 'title',
      ellipsis: true,
      render: (title: string, record) => (
        <Tooltip title={record.description || title}>
          <Text ellipsis style={{ maxWidth: 250 }}>
            {title || '-'}
          </Text>
        </Tooltip>
      ),
    },
    {
      title: '수정 버전',
      key: 'fix',
      width: 150,
      render: (_, record) => {
        if (!record.patch_available || !record.fixed_version) {
          return <Text type="secondary">-</Text>;
        }

        return (
          <Space direction="vertical" size={0}>
            <Tag color="blue">{record.fixed_version}</Tag>
            {record.upgrade_command && (
              <Tooltip title={record.upgrade_command}>
                <Button
                  type="link"
                  size="small"
                  icon={<CopyOutlined />}
                  onClick={() => {
                    navigator.clipboard.writeText(record.upgrade_command || '');
                    message.success('업그레이드 명령어가 복사되었습니다');
                  }}
                  style={{ padding: 0, fontSize: 11 }}
                >
                  명령어 복사
                </Button>
              </Tooltip>
            )}
          </Space>
        );
      },
    },
    {
      title: '상태',
      dataIndex: 'status',
      key: 'status',
      width: 90,
      render: (status: VulnerabilityStatus) => {
        const icons = {
          open: <ExclamationCircleOutlined />,
          ignored: <CloseCircleOutlined />,
          resolved: <CheckCircleOutlined />,
        };
        return (
          <Tag color={STATUS_COLORS[status]} icon={icons[status]}>
            {STATUS_LABELS[status]}
          </Tag>
        );
      },
    },
    {
      title: '참조',
      dataIndex: 'references',
      key: 'references',
      width: 70,
      align: 'center',
      render: (refs: string) => <ReferencesPopover references={refs} />,
    },
    {
      title: '',
      key: 'actions',
      width: 100,
      fixed: 'right',
      render: (_, record) => (
        <Space size={4}>
          {onViewDetail && (
            <Tooltip title="상세 보기">
              <Button
                type="link"
                size="small"
                onClick={() => onViewDetail(record)}
              >
                상세
              </Button>
            </Tooltip>
          )}
          {record.status === 'open' && onIgnore && (
            <Tooltip title="무시">
              <Button
                type="link"
                size="small"
                danger
                onClick={() => onIgnore(record)}
              >
                무시
              </Button>
            </Tooltip>
          )}
          {record.status === 'ignored' && onUnignore && (
            <Tooltip title="무시 해제">
              <Button
                type="link"
                size="small"
                onClick={() => onUnignore(record)}
              >
                해제
              </Button>
            </Tooltip>
          )}
        </Space>
      ),
    },
  ];

  return (
    <div>
      {/* 필터 영역 */}
      <Space style={{ marginBottom: 16, flexWrap: 'wrap' }} size={12}>
        <Input
          placeholder="CVE ID, 컴포넌트, 제목 검색..."
          prefix={<SearchOutlined />}
          value={searchText}
          onChange={e => setSearchText(e.target.value)}
          style={{ width: 280 }}
          allowClear
        />
        <Select
          placeholder="심각도"
          value={severityFilter}
          onChange={setSeverityFilter}
          style={{ width: 120 }}
          options={[
            { label: '전체 심각도', value: 'all' },
            { label: 'Critical', value: 'critical' },
            { label: 'High', value: 'high' },
            { label: 'Medium', value: 'medium' },
            { label: 'Low', value: 'low' },
          ]}
        />
        <Select
          placeholder="상태"
          value={statusFilter}
          onChange={setStatusFilter}
          style={{ width: 120 }}
          options={[
            { label: '전체 상태', value: 'all' },
            { label: '미해결', value: 'open' },
            { label: '무시됨', value: 'ignored' },
            { label: '해결됨', value: 'resolved' },
          ]}
        />
        <Badge count={filteredData.length} showZero color="#1890ff">
          <Tag icon={<FilterOutlined />}>필터 결과</Tag>
        </Badge>
      </Space>

      {/* 테이블 */}
      <Table
        columns={columns}
        dataSource={filteredData}
        rowKey="id"
        loading={loading}
        size="middle"
        pagination={{
          pageSize,
          showSizeChanger: true,
          showTotal: (total, range) => `${range[0]}-${range[1]} / 총 ${total}건`,
          pageSizeOptions: ['10', '20', '50', '100'],
        }}
        scroll={{ x: 1200 }}
        locale={{
          emptyText: searchText || severityFilter !== 'all' || statusFilter !== 'all'
            ? '검색 결과가 없습니다'
            : '취약점이 없습니다',
        }}
        rowClassName={(record) => {
          if (record.severity === 'critical') return 'vuln-row-critical';
          if (record.severity === 'high') return 'vuln-row-high';
          return '';
        }}
        style={{
          background: '#fff',
          borderRadius: 8,
        }}
      />

      <style>{`
        .vuln-row-critical {
          background-color: #fff1f0 !important;
        }
        .vuln-row-critical:hover > td {
          background-color: #ffccc7 !important;
        }
        .vuln-row-high {
          background-color: #fff7e6 !important;
        }
        .vuln-row-high:hover > td {
          background-color: #ffe7ba !important;
        }
      `}</style>
    </div>
  );
};

export default VulnerabilityTable;
