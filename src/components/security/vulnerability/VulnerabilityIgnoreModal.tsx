/**
 * Vulnerability Ignore Modal
 *
 * 취약점 무시 사유 입력 모달
 */

import React, { useState } from 'react';
import {
  Modal,
  Form,
  Input,
  DatePicker,
  Space,
  Typography,
  Tag,
  Alert,
  message,
} from 'antd';
import { WarningOutlined } from '@ant-design/icons';
import type { VulnerabilityAlert } from '../../../types/vulnerability';
import { SEVERITY_COLORS, SEVERITY_LABELS } from '../../../types/vulnerability';

const { TextArea } = Input;
const { Text } = Typography;

interface VulnerabilityIgnoreModalProps {
  visible: boolean;
  vulnerability: VulnerabilityAlert | null;
  loading?: boolean;
  onConfirm: (alertId: number, reason: string) => Promise<void>;
  onCancel: () => void;
}

export const VulnerabilityIgnoreModal: React.FC<VulnerabilityIgnoreModalProps> = ({
  visible,
  vulnerability,
  loading = false,
  onConfirm,
  onCancel,
}) => {
  const [form] = Form.useForm();
  const [submitting, setSubmitting] = useState(false);

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();
      setSubmitting(true);

      if (vulnerability) {
        await onConfirm(vulnerability.id, values.reason);
        form.resetFields();
        message.success('취약점이 무시 처리되었습니다');
      }
    } catch (error) {
      // 폼 검증 실패
    } finally {
      setSubmitting(false);
    }
  };

  const handleCancel = () => {
    form.resetFields();
    onCancel();
  };

  if (!vulnerability) return null;

  return (
    <Modal
      title={
        <Space>
          <WarningOutlined style={{ color: '#faad14' }} />
          <span>취약점 무시</span>
        </Space>
      }
      open={visible}
      onOk={handleSubmit}
      onCancel={handleCancel}
      confirmLoading={submitting || loading}
      okText="무시하기"
      cancelText="취소"
      okButtonProps={{ danger: true }}
      width={600}
    >
      <Alert
        message="주의: 이 작업은 감사 로그에 기록됩니다"
        description="무시된 취약점은 경고에서 제외되지만, 실제 위험이 완전히 사라지는 것은 아닙니다. 타당한 사유가 있는 경우에만 무시 처리해 주세요."
        type="warning"
        showIcon
        style={{ marginBottom: 16 }}
      />

      {/* 취약점 정보 요약 */}
      <div
        style={{
          background: '#fafafa',
          padding: 12,
          borderRadius: 8,
          marginBottom: 16,
        }}
      >
        <Space direction="vertical" size={4}>
          <Space>
            <Tag color={SEVERITY_COLORS[vulnerability.severity]}>
              {SEVERITY_LABELS[vulnerability.severity]}
            </Tag>
            <Text strong>{vulnerability.cve_id}</Text>
            <Text type="secondary">CVSS {vulnerability.cvss_score.toFixed(1)}</Text>
          </Space>
          <Text>
            {vulnerability.component_name}@{vulnerability.component_version}
          </Text>
          <Text type="secondary" ellipsis>
            {vulnerability.title}
          </Text>
        </Space>
      </div>

      <Form form={form} layout="vertical">
        <Form.Item
          name="reason"
          label="무시 사유"
          rules={[
            { required: true, message: '무시 사유를 입력해주세요' },
            { min: 10, message: '최소 10자 이상 입력해주세요' },
          ]}
        >
          <TextArea
            rows={4}
            placeholder="이 취약점을 무시하는 사유를 상세히 입력해주세요. (예: 해당 기능을 사용하지 않음, 내부 네트워크에서만 접근 가능, 다른 보안 조치로 완화됨 등)"
            maxLength={500}
            showCount
          />
        </Form.Item>

        {/* 선택적: 만료일 설정 (예외 규칙용) */}
        {/* <Form.Item
          name="expiresAt"
          label="무시 만료일 (선택)"
          extra="만료일을 설정하면 해당 날짜 이후 다시 경고가 표시됩니다."
        >
          <DatePicker
            style={{ width: '100%' }}
            placeholder="만료일 선택 (선택사항)"
            disabledDate={(current) => current && current < dayjs().endOf('day')}
          />
        </Form.Item> */}
      </Form>

      <Text type="secondary" style={{ fontSize: 12 }}>
        * 무시된 취약점은 언제든지 무시 해제할 수 있습니다.
      </Text>
    </Modal>
  );
};

export default VulnerabilityIgnoreModal;
