/**
 * Vulnerability Detail Modal
 *
 * 취약점 상세 정보를 표시하는 모달
 * - CVE 정보
 * - 영향 범위
 * - 수정 버전 및 업그레이드 명령
 * - 참조 URL
 */

import React from 'react';
import {
  Modal,
  Descriptions,
  Tag,
  Space,
  Typography,
  Button,
  Divider,
  List,
  message,
  Alert,
  Tooltip,
} from 'antd';
import {
  CopyOutlined,
  ExportOutlined,
  CheckCircleOutlined,
  WarningOutlined,
  ClockCircleOutlined,
  SafetyOutlined,
} from '@ant-design/icons';
import type { VulnerabilityAlert } from '../../../types/vulnerability';
import {
  SEVERITY_COLORS,
  SEVERITY_LABELS,
  SEVERITY_LABELS_KO,
  STATUS_COLORS,
  STATUS_LABELS,
  parseReferences,
  parseCWEIds,
} from '../../../types/vulnerability';

const { Text, Link, Paragraph, Title } = Typography;

interface VulnerabilityDetailModalProps {
  visible: boolean;
  vulnerability: VulnerabilityAlert | null;
  onClose: () => void;
  onIgnore?: (alert: VulnerabilityAlert) => void;
}

export const VulnerabilityDetailModal: React.FC<VulnerabilityDetailModalProps> = ({
  visible,
  vulnerability,
  onClose,
  onIgnore,
}) => {
  if (!vulnerability) return null;

  const references = parseReferences(vulnerability.references);
  const cweIds = parseCWEIds(vulnerability.cwe_ids);
  const isCVE = vulnerability.cve_id?.startsWith('CVE-');

  const handleCopyCommand = () => {
    if (vulnerability.upgrade_command) {
      navigator.clipboard.writeText(vulnerability.upgrade_command);
      message.success('업그레이드 명령어가 복사되었습니다');
    }
  };

  const handleCopyCVE = () => {
    navigator.clipboard.writeText(vulnerability.cve_id);
    message.success('CVE ID가 복사되었습니다');
  };

  return (
    <Modal
      title={
        <Space>
          <WarningOutlined style={{ color: SEVERITY_COLORS[vulnerability.severity] }} />
          <span>취약점 상세 정보</span>
          <Tag color={SEVERITY_COLORS[vulnerability.severity]}>
            {SEVERITY_LABELS[vulnerability.severity]}
          </Tag>
        </Space>
      }
      open={visible}
      onCancel={onClose}
      width={800}
      footer={[
        vulnerability.status === 'open' && onIgnore && (
          <Button
            key="ignore"
            danger
            onClick={() => {
              onIgnore(vulnerability);
              onClose();
            }}
          >
            무시하기
          </Button>
        ),
        <Button key="close" type="primary" onClick={onClose}>
          닫기
        </Button>,
      ]}
    >
      {/* 수정 가능 알림 */}
      {vulnerability.patch_available && (
        <Alert
          message={
            <Space>
              <SafetyOutlined />
              <Text strong>패치 가능</Text>
              <Text>
                버전 <Text code>{vulnerability.fixed_version}</Text>으로 업그레이드하여 해결할 수 있습니다.
              </Text>
            </Space>
          }
          type="success"
          showIcon={false}
          style={{ marginBottom: 16 }}
          action={
            vulnerability.upgrade_command && (
              <Button size="small" type="primary" onClick={handleCopyCommand}>
                명령어 복사
              </Button>
            )
          }
        />
      )}

      <Descriptions column={2} bordered size="small">
        <Descriptions.Item label="CVE ID" span={1}>
          <Space>
            <Link
              href={isCVE
                ? `https://nvd.nist.gov/vuln/detail/${vulnerability.cve_id}`
                : `https://osv.dev/vulnerability/${vulnerability.cve_id}`
              }
              target="_blank"
            >
              {vulnerability.cve_id} <ExportOutlined />
            </Link>
            <Tooltip title="복사">
              <Button
                type="text"
                size="small"
                icon={<CopyOutlined />}
                onClick={handleCopyCVE}
              />
            </Tooltip>
          </Space>
        </Descriptions.Item>

        <Descriptions.Item label="CVSS 점수" span={1}>
          <Space>
            <Tag
              color={SEVERITY_COLORS[vulnerability.severity]}
              style={{ fontWeight: 'bold', fontSize: 14 }}
            >
              {vulnerability.cvss_score.toFixed(1)}
            </Tag>
            <Text type="secondary">({vulnerability.cvss_version || 'CVSS 3.1'})</Text>
          </Space>
        </Descriptions.Item>

        <Descriptions.Item label="상태" span={1}>
          <Tag color={STATUS_COLORS[vulnerability.status]}>
            {STATUS_LABELS[vulnerability.status]}
          </Tag>
        </Descriptions.Item>

        <Descriptions.Item label="데이터 소스" span={1}>
          <Tag>{vulnerability.data_source?.toUpperCase() || 'OSV'}</Tag>
        </Descriptions.Item>

        <Descriptions.Item label="컴포넌트" span={2}>
          <Space direction="vertical" size={0}>
            <Text strong>{vulnerability.component_name}</Text>
            <Text type="secondary">버전: {vulnerability.component_version || '-'}</Text>
            {vulnerability.purl && (
              <Text type="secondary" copyable={{ text: vulnerability.purl }}>
                PURL: {vulnerability.purl}
              </Text>
            )}
          </Space>
        </Descriptions.Item>
      </Descriptions>

      <Divider orientation="left" style={{ marginTop: 24 }}>
        <Space>
          <WarningOutlined />
          취약점 정보
        </Space>
      </Divider>

      <Title level={5} style={{ marginBottom: 8 }}>
        {vulnerability.title || '제목 없음'}
      </Title>

      <Paragraph
        ellipsis={{ rows: 5, expandable: true, symbol: '더 보기' }}
        style={{ marginBottom: 16 }}
      >
        {vulnerability.description || '설명이 없습니다.'}
      </Paragraph>

      {/* CWE 정보 */}
      {cweIds.length > 0 && (
        <div style={{ marginBottom: 16 }}>
          <Text strong>CWE: </Text>
          <Space size={4} wrap>
            {cweIds.map(cwe => (
              <Link
                key={cwe}
                href={`https://cwe.mitre.org/data/definitions/${cwe.replace('CWE-', '')}.html`}
                target="_blank"
              >
                <Tag>{cwe}</Tag>
              </Link>
            ))}
          </Space>
        </div>
      )}

      {/* 수정 버전 정보 */}
      {vulnerability.patch_available && vulnerability.fixed_version && (
        <>
          <Divider orientation="left">
            <Space>
              <CheckCircleOutlined style={{ color: '#52c41a' }} />
              해결 방법
            </Space>
          </Divider>

          <Descriptions column={1} bordered size="small">
            <Descriptions.Item label="수정된 버전">
              <Tag color="blue" style={{ fontSize: 14 }}>
                {vulnerability.fixed_version}
              </Tag>
            </Descriptions.Item>

            {vulnerability.upgrade_command && (
              <Descriptions.Item label="업그레이드 명령어">
                <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                  <Text code style={{ fontSize: 13 }}>
                    {vulnerability.upgrade_command}
                  </Text>
                  <Button
                    type="primary"
                    size="small"
                    icon={<CopyOutlined />}
                    onClick={handleCopyCommand}
                  >
                    복사
                  </Button>
                </Space>
              </Descriptions.Item>
            )}
          </Descriptions>
        </>
      )}

      {/* 참조 URL */}
      {references.length > 0 && (
        <>
          <Divider orientation="left">
            <Space>
              <ExportOutlined />
              참조 ({references.length}개)
            </Space>
          </Divider>

          <List
            size="small"
            dataSource={references.slice(0, 10)}
            renderItem={url => (
              <List.Item style={{ padding: '4px 0' }}>
                <Link href={url} target="_blank" ellipsis style={{ maxWidth: '100%' }}>
                  {url}
                </Link>
              </List.Item>
            )}
            style={{ maxHeight: 200, overflow: 'auto' }}
          />
          {references.length > 10 && (
            <Text type="secondary" style={{ display: 'block', marginTop: 8 }}>
              외 {references.length - 10}개의 참조 URL이 있습니다.
            </Text>
          )}
        </>
      )}

      {/* 날짜 정보 */}
      <Divider orientation="left">
        <Space>
          <ClockCircleOutlined />
          타임라인
        </Space>
      </Divider>

      <Descriptions column={2} size="small">
        <Descriptions.Item label="공개일">
          {vulnerability.published_at
            ? new Date(vulnerability.published_at).toLocaleDateString('ko-KR')
            : '-'}
        </Descriptions.Item>
        <Descriptions.Item label="수정일">
          {vulnerability.modified_at
            ? new Date(vulnerability.modified_at).toLocaleDateString('ko-KR')
            : '-'}
        </Descriptions.Item>
        <Descriptions.Item label="발견일">
          {new Date(vulnerability.created_at).toLocaleDateString('ko-KR')}
        </Descriptions.Item>
        {vulnerability.status === 'ignored' && vulnerability.ignored_at && (
          <Descriptions.Item label="무시 처리일">
            {new Date(vulnerability.ignored_at).toLocaleDateString('ko-KR')}
            {vulnerability.ignored_by && ` (${vulnerability.ignored_by})`}
          </Descriptions.Item>
        )}
      </Descriptions>

      {/* 무시 사유 */}
      {vulnerability.status === 'ignored' && vulnerability.ignored_reason && (
        <Alert
          message="무시 사유"
          description={vulnerability.ignored_reason}
          type="warning"
          style={{ marginTop: 16 }}
        />
      )}
    </Modal>
  );
};

export default VulnerabilityDetailModal;
