/**
 * VulnerabilityChecklistCard.tsx
 *
 * 개별 취약점 체크리스트 아이템 컴포넌트
 * - 체크박스로 해결 상태 관리
 * - 심각도별 색상 표시
 * - 소스 도구 태그 표시
 */

import React, { useState } from 'react';
import {
  Card,
  Checkbox,
  Tag,
  Typography,
  Space,
  Tooltip,
  Button,
  Dropdown,
  Popconfirm,
} from 'antd';
import type { MenuProps } from 'antd';
import {
  FileTextOutlined,
  LinkOutlined,
  InfoCircleOutlined,
  MoreOutlined,
  CheckCircleOutlined,
  CloseCircleOutlined,
  WarningOutlined,
} from '@ant-design/icons';
import type {
  VulnerabilityChecklistItem,
  ChecklistItemStatus,
  SeverityLevel,
  SourceTool,
} from '../../types/securityAnalysis';
import {
  severityColors,
  sourceToolLabels,
  checklistStatusLabels,
} from '../../types/securityAnalysis';

const { Text, Paragraph } = Typography;

interface VulnerabilityChecklistCardProps {
  item: VulnerabilityChecklistItem;
  onStatusChange: (
    itemId: string,
    newStatus: ChecklistItemStatus
  ) => Promise<void>;
  loading?: boolean;
  compact?: boolean;
}

/**
 * 심각도 태그 컴포넌트
 */
const SeverityTag: React.FC<{ severity: SeverityLevel }> = ({ severity }) => {
  const labels: Record<SeverityLevel, string> = {
    critical: 'CRITICAL',
    high: 'HIGH',
    medium: 'MEDIUM',
    low: 'LOW',
    info: 'INFO',
  };

  return (
    <Tag
      color={severityColors[severity]}
      style={{ fontWeight: 600, fontSize: '11px' }}
    >
      {labels[severity]}
    </Tag>
  );
};

/**
 * 소스 도구 태그 컴포넌트
 */
const SourceToolTag: React.FC<{ tool: SourceTool }> = ({ tool }) => {
  const colors: Record<SourceTool, string> = {
    semgrep: 'blue',
    codeql: 'purple',
    trivy: 'green',
    zap: 'orange',
    other: 'default',
  };

  return (
    <Tag color={colors[tool]} style={{ fontSize: '10px' }}>
      {sourceToolLabels[tool]}
    </Tag>
  );
};

/**
 * 상태 아이콘 컴포넌트
 */
const StatusIcon: React.FC<{ status: ChecklistItemStatus }> = ({ status }) => {
  switch (status) {
    case 'resolved':
      return <CheckCircleOutlined style={{ color: '#52c41a' }} />;
    case 'false_positive':
      return <CloseCircleOutlined style={{ color: '#8c8c8c' }} />;
    case 'accepted_risk':
      return <WarningOutlined style={{ color: '#faad14' }} />;
    default:
      return null;
  }
};

export const VulnerabilityChecklistCard: React.FC<
  VulnerabilityChecklistCardProps
> = ({ item, onStatusChange, loading = false, compact = false }) => {
  const [isUpdating, setIsUpdating] = useState(false);

  const isResolved = item.status !== 'open';

  const handleCheckboxChange = async () => {
    if (isUpdating) return;

    setIsUpdating(true);
    try {
      const newStatus: ChecklistItemStatus = isResolved ? 'open' : 'resolved';
      await onStatusChange(item.item_id, newStatus);
    } finally {
      setIsUpdating(false);
    }
  };

  const handleMenuClick = async (status: ChecklistItemStatus) => {
    if (isUpdating || status === item.status) return;

    setIsUpdating(true);
    try {
      await onStatusChange(item.item_id, status);
    } finally {
      setIsUpdating(false);
    }
  };

  const dropdownItems: MenuProps['items'] = [
    {
      key: 'resolved',
      label: checklistStatusLabels.resolved,
      icon: <CheckCircleOutlined style={{ color: '#52c41a' }} />,
      onClick: () => handleMenuClick('resolved'),
    },
    {
      key: 'false_positive',
      label: checklistStatusLabels.false_positive,
      icon: <CloseCircleOutlined style={{ color: '#8c8c8c' }} />,
      onClick: () => handleMenuClick('false_positive'),
    },
    {
      key: 'accepted_risk',
      label: checklistStatusLabels.accepted_risk,
      icon: <WarningOutlined style={{ color: '#faad14' }} />,
      onClick: () => handleMenuClick('accepted_risk'),
    },
    {
      type: 'divider',
    },
    {
      key: 'open',
      label: '미해결로 되돌리기',
      onClick: () => handleMenuClick('open'),
    },
  ];

  if (compact) {
    return (
      <div
        style={{
          display: 'flex',
          alignItems: 'center',
          padding: '8px 12px',
          borderBottom: '1px solid #f0f0f0',
          opacity: isResolved ? 0.6 : 1,
          backgroundColor: isResolved ? '#fafafa' : 'transparent',
        }}
      >
        <Popconfirm
          title={
            isResolved
              ? '미해결로 되돌리시겠습니까?'
              : '해결 완료로 표시하시겠습니까?'
          }
          onConfirm={handleCheckboxChange}
          okText='확인'
          cancelText='취소'
          disabled={isUpdating || loading}
        >
          <Checkbox
            checked={isResolved}
            disabled={isUpdating || loading}
            style={{ marginRight: 12 }}
          />
        </Popconfirm>

        <Space style={{ flex: 1 }}>
          <SeverityTag severity={item.severity} />
          <Text
            style={{
              textDecoration: isResolved ? 'line-through' : 'none',
              color: isResolved ? '#8c8c8c' : 'inherit',
            }}
          >
            {item.title}
          </Text>
          {isResolved && <StatusIcon status={item.status} />}
        </Space>

        <Space>
          <SourceToolTag tool={item.source_tool} />
          {item.cve_id && <Tag style={{ fontSize: '10px' }}>{item.cve_id}</Tag>}
        </Space>
      </div>
    );
  }

  return (
    <Card
      size='small'
      style={{
        marginBottom: 8,
        opacity: isResolved ? 0.7 : 1,
        backgroundColor: isResolved ? '#fafafa' : '#fff',
        borderLeft: `3px solid ${severityColors[item.severity]}`,
      }}
      bodyStyle={{ padding: '12px 16px' }}
    >
      <div style={{ display: 'flex', alignItems: 'flex-start' }}>
        <Popconfirm
          title={
            isResolved
              ? '미해결로 되돌리시겠습니까?'
              : '해결 완료로 표시하시겠습니까?'
          }
          onConfirm={handleCheckboxChange}
          okText='확인'
          cancelText='취소'
          disabled={isUpdating || loading}
        >
          <Checkbox
            checked={isResolved}
            disabled={isUpdating || loading}
            style={{ marginRight: 12, marginTop: 4 }}
          />
        </Popconfirm>

        <div style={{ flex: 1 }}>
          <div
            style={{ display: 'flex', alignItems: 'center', marginBottom: 8 }}
          >
            <SeverityTag severity={item.severity} />
            <SourceToolTag tool={item.source_tool} />
            {item.cwe_id && (
              <Tag style={{ fontSize: '10px' }}>{item.cwe_id}</Tag>
            )}
            {item.cve_id && (
              <Tag color='red' style={{ fontSize: '10px' }}>
                {item.cve_id}
              </Tag>
            )}
            {isResolved && (
              <Tag
                color={item.status === 'resolved' ? 'green' : 'default'}
                style={{ marginLeft: 8 }}
              >
                <StatusIcon status={item.status} />
                <span style={{ marginLeft: 4 }}>
                  {checklistStatusLabels[item.status]}
                </span>
              </Tag>
            )}
          </div>

          <Text
            strong
            style={{
              textDecoration: isResolved ? 'line-through' : 'none',
              color: isResolved ? '#8c8c8c' : 'inherit',
              display: 'block',
              marginBottom: 4,
            }}
          >
            {item.title}
          </Text>

          {item.description && (
            <Paragraph
              type='secondary'
              style={{
                fontSize: '12px',
                marginBottom: 8,
                textDecoration: isResolved ? 'line-through' : 'none',
              }}
              ellipsis={{ rows: 2, expandable: true }}
            >
              {item.description}
            </Paragraph>
          )}

          <Space size={16} style={{ fontSize: '12px' }}>
            {item.file_path && (
              <Tooltip title='파일 위치'>
                <Space size={4}>
                  <FileTextOutlined style={{ color: '#8c8c8c' }} />
                  <Text type='secondary' style={{ fontSize: '11px' }}>
                    {item.file_path}
                    {item.line_number && `:${item.line_number}`}
                  </Text>
                </Space>
              </Tooltip>
            )}
            {item.reference_url && (
              <Tooltip title='참조 링크'>
                <a
                  href={item.reference_url}
                  target='_blank'
                  rel='noopener noreferrer'
                  style={{ fontSize: '11px' }}
                >
                  <LinkOutlined /> 참조
                </a>
              </Tooltip>
            )}
            {item.recommendation && (
              <Tooltip title={item.recommendation}>
                <Space size={4} style={{ color: '#1890ff', cursor: 'pointer' }}>
                  <InfoCircleOutlined />
                  <Text style={{ fontSize: '11px', color: '#1890ff' }}>
                    권장사항
                  </Text>
                </Space>
              </Tooltip>
            )}
          </Space>

          {item.resolved_at && (
            <div style={{ marginTop: 8 }}>
              <Text type='secondary' style={{ fontSize: '11px' }}>
                {new Date(item.resolved_at).toLocaleString('ko-KR')}에 처리됨
                {item.resolved_by && ` (${item.resolved_by})`}
              </Text>
            </div>
          )}
        </div>

        <Dropdown menu={{ items: dropdownItems }} trigger={['click']}>
          <Button
            type='text'
            size='small'
            icon={<MoreOutlined />}
            disabled={isUpdating || loading}
          />
        </Dropdown>
      </div>
    </Card>
  );
};

export default VulnerabilityChecklistCard;
