/**
 * VulnerabilityCard - 통일된 취약점 상세 카드 컴포넌트
 *
 * SAST, SCA, DAST 모든 보안 분석 결과에서 동일한 스타일로
 * 개별 취약점 정보를 표시합니다.
 */

import React from 'react';
import {
  Card,
  Tag,
  Typography,
  Space,
  Descriptions,
  Button,
  Tooltip,
  Collapse,
} from 'antd';
import {
  FileTextOutlined,
  CodeOutlined,
  LinkOutlined,
  BugOutlined,
  EnvironmentOutlined,
  ExclamationCircleOutlined,
  WarningOutlined,
  InfoCircleOutlined,
  CheckCircleOutlined,
  RightOutlined,
} from '@ant-design/icons';
import {
  SeverityLevel,
  severityColors,
  severityLabels,
  cardStyles,
  tagStyles,
  spacing,
  borderRadius,
  parseSeverity,
  getSeverityTagColor,
} from './securityTheme';

const { Text, Paragraph } = Typography;

/**
 * 심각도별 아이콘 매핑
 */
const severityIcons: Record<SeverityLevel, React.ReactNode> = {
  critical: <ExclamationCircleOutlined />,
  high: <WarningOutlined />,
  medium: <WarningOutlined />,
  low: <InfoCircleOutlined />,
  info: <CheckCircleOutlined />,
};

/**
 * 취약점 카드 공통 Props
 */
interface VulnerabilityCardBaseProps {
  /** 취약점 ID 또는 CVE */
  id?: string;
  /** 취약점 제목/이름 */
  title: string;
  /** 심각도 */
  severity: string;
  /** 상세 설명 */
  description?: string;
  /** 카드 인덱스 (리스트에서의 순번) */
  index?: number;
  /** 카드 클릭 핸들러 */
  onClick?: () => void;
  /** 추가 액션 버튼들 */
  actions?: React.ReactNode;
  /** 추가 메타 정보 */
  children?: React.ReactNode;
}

/**
 * SAST 취약점 카드 Props
 */
export interface SastVulnerabilityProps extends VulnerabilityCardBaseProps {
  type: 'sast';
  /** 파일 경로 */
  filePath?: string;
  /** 라인 번호 */
  lineNumber?: number | string;
  /** 코드 스니펫 */
  codeSnippet?: string;
  /** 규칙 ID */
  ruleId?: string;
  /** 카테고리 */
  category?: string;
}

/**
 * SCA 취약점 카드 Props
 */
export interface ScaVulnerabilityProps extends VulnerabilityCardBaseProps {
  type: 'sca';
  /** CVE ID */
  cveId?: string;
  /** 패키지 이름 */
  packageName?: string;
  /** 현재 버전 */
  installedVersion?: string;
  /** 수정된 버전 */
  fixedVersion?: string;
  /** CVSS 점수 */
  cvssScore?: number;
  /** 참조 URL */
  references?: string[];
}

/**
 * DAST 취약점 카드 Props
 */
export interface DastVulnerabilityProps extends VulnerabilityCardBaseProps {
  type: 'dast';
  /** 영향받는 URL */
  url?: string;
  /** 공격 방법 */
  attack?: string;
  /** 증거 */
  evidence?: string;
  /** 해결책 */
  solution?: string;
  /** CWE ID */
  cweId?: string;
}

export type VulnerabilityCardProps =
  | SastVulnerabilityProps
  | ScaVulnerabilityProps
  | DastVulnerabilityProps;

/**
 * 코드 스니펫 표시 컴포넌트
 */
const CodeSnippetBlock: React.FC<{ code?: string; language?: string }> = ({
  code,
}) => {
  if (!code) return null;

  return (
    <pre
      style={{
        background: '#1e1e1e',
        color: '#d4d4d4',
        padding: spacing.md,
        borderRadius: borderRadius.md,
        fontSize: 12,
        fontFamily: "'Fira Code', 'Consolas', monospace",
        overflow: 'auto',
        maxHeight: 200,
        margin: 0,
      }}
    >
      <code>{code}</code>
    </pre>
  );
};

/**
 * 카드 헤더 컴포넌트
 */
interface CardHeaderProps {
  severity: SeverityLevel;
  title: string;
  id?: string;
  index?: number;
  extra?: React.ReactNode;
}

const CardHeader: React.FC<CardHeaderProps> = ({
  severity,
  title,
  id,
  index,
  extra,
}) => {
  const colors = severityColors[severity];

  return (
    <div
      style={{
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'space-between',
        flexWrap: 'wrap',
        gap: spacing.sm,
      }}
    >
      <Space size={spacing.sm} wrap>
        {index !== undefined && (
          <div
            style={{
              width: 24,
              height: 24,
              borderRadius: '50%',
              background: colors.primary,
              color: '#fff',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: 12,
              fontWeight: 'bold',
            }}
          >
            {index + 1}
          </div>
        )}
        <Tag color={getSeverityTagColor(severity)} style={{ margin: 0 }}>
          {severityIcons[severity]} {severityLabels[severity]}
        </Tag>
        {id && (
          <Tag color='default' style={{ fontFamily: 'monospace' }}>
            {id}
          </Tag>
        )}
        <Text strong style={{ fontSize: 14 }}>
          {title}
        </Text>
      </Space>
      {extra}
    </div>
  );
};

/**
 * SAST 취약점 상세 내용
 */
const SastVulnerabilityContent: React.FC<SastVulnerabilityProps> = ({
  description,
  filePath,
  lineNumber,
  codeSnippet,
  ruleId,
  category,
}) => {
  return (
    <Space direction='vertical' size={spacing.md} style={{ width: '100%' }}>
      {description && (
        <Paragraph style={{ margin: 0, color: '#595959' }}>
          {description}
        </Paragraph>
      )}

      <Descriptions size='small' column={2} style={{ marginTop: spacing.sm }}>
        {filePath && (
          <Descriptions.Item
            label={
              <Space>
                <FileTextOutlined />
                파일
              </Space>
            }
            span={2}
          >
            <Text code style={{ fontSize: 12 }}>
              {filePath}
              {lineNumber && `:${lineNumber}`}
            </Text>
          </Descriptions.Item>
        )}
        {ruleId && (
          <Descriptions.Item label='규칙 ID'>
            <Tag color='purple'>{ruleId}</Tag>
          </Descriptions.Item>
        )}
        {category && (
          <Descriptions.Item label='카테고리'>
            <Tag color='blue'>{category}</Tag>
          </Descriptions.Item>
        )}
      </Descriptions>

      {codeSnippet && (
        <Collapse
          ghost
          expandIcon={({ isActive }) => (
            <RightOutlined
              rotate={isActive ? 90 : 0}
              style={{ fontSize: 10 }}
            />
          )}
          items={[
            {
              key: '1',
              label: (
                <Space>
                  <CodeOutlined />
                  <Text style={{ fontSize: 13 }}>코드 스니펫</Text>
                </Space>
              ),
              children: <CodeSnippetBlock code={codeSnippet} />,
            },
          ]}
        />
      )}
    </Space>
  );
};

/**
 * SCA 취약점 상세 내용
 */
const ScaVulnerabilityContent: React.FC<ScaVulnerabilityProps> = ({
  description,
  packageName,
  installedVersion,
  fixedVersion,
  cvssScore,
  references,
}) => {
  return (
    <Space direction='vertical' size={spacing.md} style={{ width: '100%' }}>
      {description && (
        <Paragraph style={{ margin: 0, color: '#595959' }}>
          {description}
        </Paragraph>
      )}

      <Descriptions size='small' column={2}>
        {packageName && (
          <Descriptions.Item
            label={
              <Space>
                <BugOutlined />
                패키지
              </Space>
            }
          >
            <Text strong>{packageName}</Text>
          </Descriptions.Item>
        )}
        {cvssScore !== undefined && (
          <Descriptions.Item label='CVSS 점수'>
            <Tag
              color={
                cvssScore >= 9 ? 'red' : cvssScore >= 7 ? 'orange' : 'gold'
              }
            >
              {cvssScore.toFixed(1)}
            </Tag>
          </Descriptions.Item>
        )}
        {installedVersion && (
          <Descriptions.Item label='설치 버전'>
            <Text code>{installedVersion}</Text>
          </Descriptions.Item>
        )}
        {fixedVersion && (
          <Descriptions.Item label='수정 버전'>
            <Text code style={{ color: '#52c41a' }}>
              {fixedVersion}
            </Text>
          </Descriptions.Item>
        )}
      </Descriptions>

      {references && references.length > 0 && (
        <div>
          <Text type='secondary' style={{ fontSize: 12 }}>
            <LinkOutlined /> 참조:
          </Text>
          <div style={{ marginTop: 4 }}>
            {references.slice(0, 3).map((ref, idx) => (
              <a
                key={idx}
                href={ref}
                target='_blank'
                rel='noopener noreferrer'
                style={{ display: 'block', fontSize: 12, marginBottom: 2 }}
              >
                {ref.length > 60 ? `${ref.substring(0, 60)}...` : ref}
              </a>
            ))}
            {references.length > 3 && (
              <Text type='secondary' style={{ fontSize: 11 }}>
                외 {references.length - 3}개
              </Text>
            )}
          </div>
        </div>
      )}
    </Space>
  );
};

/**
 * DAST 취약점 상세 내용
 */
const DastVulnerabilityContent: React.FC<DastVulnerabilityProps> = ({
  description,
  url,
  attack,
  evidence,
  solution,
  cweId,
}) => {
  return (
    <Space direction='vertical' size={spacing.md} style={{ width: '100%' }}>
      {description && (
        <Paragraph style={{ margin: 0, color: '#595959' }}>
          {description}
        </Paragraph>
      )}

      <Descriptions size='small' column={1}>
        {url && (
          <Descriptions.Item
            label={
              <Space>
                <EnvironmentOutlined />
                URL
              </Space>
            }
          >
            <Text code style={{ fontSize: 12, wordBreak: 'break-all' }}>
              {url}
            </Text>
          </Descriptions.Item>
        )}
        {cweId && (
          <Descriptions.Item label='CWE'>
            <Tag color='volcano'>{cweId}</Tag>
          </Descriptions.Item>
        )}
      </Descriptions>

      {attack && (
        <Collapse
          ghost
          expandIcon={({ isActive }) => (
            <RightOutlined
              rotate={isActive ? 90 : 0}
              style={{ fontSize: 10 }}
            />
          )}
          items={[
            {
              key: 'attack',
              label: (
                <Space>
                  <ExclamationCircleOutlined />
                  <Text style={{ fontSize: 13 }}>공격 내용</Text>
                </Space>
              ),
              children: (
                <pre
                  style={{
                    background: '#f5f5f5',
                    padding: spacing.sm,
                    borderRadius: borderRadius.sm,
                    fontSize: 12,
                    whiteSpace: 'pre-wrap',
                    wordBreak: 'break-word',
                    margin: 0,
                  }}
                >
                  {attack}
                </pre>
              ),
            },
          ]}
        />
      )}

      {evidence && (
        <div>
          <Text type='secondary' style={{ fontSize: 12 }}>
            증거:
          </Text>
          <Paragraph
            style={{
              background: '#fffbe6',
              padding: spacing.sm,
              borderRadius: borderRadius.sm,
              fontSize: 12,
              margin: '4px 0 0 0',
              border: '1px solid #ffe58f',
            }}
          >
            {evidence}
          </Paragraph>
        </div>
      )}

      {solution && (
        <div>
          <Text type='secondary' style={{ fontSize: 12 }}>
            <CheckCircleOutlined /> 해결책:
          </Text>
          <Paragraph
            style={{
              background: '#f6ffed',
              padding: spacing.sm,
              borderRadius: borderRadius.sm,
              fontSize: 12,
              margin: '4px 0 0 0',
              border: '1px solid #b7eb8f',
            }}
          >
            {solution}
          </Paragraph>
        </div>
      )}
    </Space>
  );
};

/**
 * 통일된 취약점 카드 메인 컴포넌트
 */
export const VulnerabilityCard: React.FC<VulnerabilityCardProps> = props => {
  const { title, severity, id, index, onClick, actions, children } = props;
  const parsedSeverity = parseSeverity(severity);

  const renderContent = () => {
    switch (props.type) {
      case 'sast':
        return <SastVulnerabilityContent {...props} />;
      case 'sca':
        return <ScaVulnerabilityContent {...props} />;
      case 'dast':
        return <DastVulnerabilityContent {...props} />;
      default:
        return null;
    }
  };

  return (
    <Card
      size='small'
      style={cardStyles.vulnerabilityDetail(parsedSeverity)}
      styles={{
        header: cardStyles.vulnerabilityDetailHeader(parsedSeverity),
        body: { padding: spacing.lg },
      }}
      title={
        <CardHeader
          severity={parsedSeverity}
          title={title}
          id={id}
          index={index}
          extra={actions}
        />
      }
      hoverable={!!onClick}
      onClick={onClick}
    >
      {renderContent()}
      {children}
    </Card>
  );
};

/**
 * 간단한 취약점 리스트 아이템 (축약형)
 */
interface VulnerabilityListItemProps {
  title: string;
  severity: string;
  id?: string;
  subtitle?: string;
  onClick?: () => void;
}

export const VulnerabilityListItem: React.FC<VulnerabilityListItemProps> = ({
  title,
  severity,
  id,
  subtitle,
  onClick,
}) => {
  const parsedSeverity = parseSeverity(severity);
  const colors = severityColors[parsedSeverity];

  return (
    <div
      onClick={onClick}
      style={{
        padding: `${spacing.sm}px ${spacing.md}px`,
        borderLeft: `4px solid ${colors.primary}`,
        background: colors.light,
        marginBottom: spacing.sm,
        borderRadius: `0 ${borderRadius.sm}px ${borderRadius.sm}px 0`,
        cursor: onClick ? 'pointer' : 'default',
        transition: 'all 0.2s ease',
      }}
    >
      <Space>
        <Tag color={getSeverityTagColor(parsedSeverity)} style={{ margin: 0 }}>
          {severityLabels[parsedSeverity]}
        </Tag>
        {id && (
          <Text code style={{ fontSize: 11 }}>
            {id}
          </Text>
        )}
      </Space>
      <div style={{ marginTop: 4 }}>
        <Text strong style={{ fontSize: 13 }}>
          {title}
        </Text>
        {subtitle && (
          <Text type='secondary' style={{ fontSize: 12, marginLeft: 8 }}>
            {subtitle}
          </Text>
        )}
      </div>
    </div>
  );
};

export default VulnerabilityCard;
