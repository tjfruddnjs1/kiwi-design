import React, { useState } from 'react';
import { Card, List, Tag, Space, Typography, Button } from 'antd';
import {
  BugOutlined,
  MonitorOutlined,
  AlertOutlined,
  CheckCircleOutlined,
  WarningOutlined,
  CloseCircleOutlined,
  ClockCircleOutlined,
  DownOutlined,
  UpOutlined,
} from '@ant-design/icons';
import {
  SASTReport,
  DASTReport,
  SecurityVulnerability,
} from '../../data/mockProjects';

const { Text } = Typography;

interface SecurityVulnerabilityCardProps {
  title: string;
  type: 'sast' | 'dast' | 'sca';
  data?: any;
  loading?: boolean;
}

const SecurityVulnerabilityCard: React.FC<SecurityVulnerabilityCardProps> = ({
  title,
  type,
  data,
  loading = false,
}) => {
  const [expandedItems, setExpandedItems] = useState<{
    sast: Set<string>;
    dast: Set<string>;
    sca: Set<string>;
  }>({ sast: new Set(), dast: new Set(), sca: new Set() });

  const toggleExpanded = (itemId: string) => {
    const newExpanded = { ...expandedItems };
    if (newExpanded[type].has(itemId)) {
      newExpanded[type].delete(itemId);
    } else {
      newExpanded[type].add(itemId);
    }
    setExpandedItems(newExpanded);
  };

  const isExpanded = (itemId: string) => expandedItems[type].has(itemId);

  const generateUniqueId = (vuln: SecurityVulnerability, index: number) => {
    // 간단하게 index를 사용하여 고유 ID 생성
    return `${type}-${index}`;
  };
  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical':
        return 'red';
      case 'high':
        return 'orange';
      case 'medium':
        return 'gold';
      case 'low':
        return 'blue';
      default:
        return 'default';
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'open':
      case 'new':
        return <CloseCircleOutlined style={{ color: '#f5222d' }} />;
      case 'inProgress':
      case 'investigating':
      case 'acknowledged':
        return <ClockCircleOutlined style={{ color: '#fa8c16' }} />;
      case 'resolved':
        return <CheckCircleOutlined style={{ color: '#52c41a' }} />;
      default:
        return <WarningOutlined style={{ color: '#faad14' }} />;
    }
  };

  const renderSASTContent = (sastData: SASTReport) => (
    <div>
      <Space direction='vertical' style={{ width: '100%' }} size='middle'>
        {/* Severity Breakdown */}
        <div>
          <Text strong style={{ marginBottom: 8, display: 'block' }}>
            심각도별 분포
          </Text>
          <Space wrap>
            <Tag color='red'>Critical: {sastData.criticalCount}</Tag>
            <Tag color='orange'>High: {sastData.highCount}</Tag>
            <Tag color='gold'>Medium: {sastData.mediumCount}</Tag>
            <Tag color='blue'>Low: {sastData.lowCount}</Tag>
          </Space>
        </div>

        {/* Recent Vulnerabilities */}
        {sastData.vulnerabilities && sastData.vulnerabilities.length > 0 && (
          <div>
            <Text strong style={{ marginBottom: 8, display: 'block' }}>
              취약점 리스트
            </Text>
            <List
              size='small'
              dataSource={sastData.vulnerabilities}
              style={{ maxHeight: '400px', overflowY: 'auto' }}
              renderItem={(vuln: SecurityVulnerability, index: number) => (
                <List.Item>
                  <List.Item.Meta
                    avatar={getStatusIcon(vuln.status)}
                    title={
                      <Space
                        style={{
                          width: '100%',
                          justifyContent: 'space-between',
                        }}
                      >
                        <Space>
                          <Text
                            style={{ fontSize: '13px' }}
                            ellipsis={
                              isExpanded(generateUniqueId(vuln, index))
                                ? false
                                : {
                                    tooltip: vuln.title,
                                  }
                            }
                          >
                            {isExpanded(generateUniqueId(vuln, index))
                              ? vuln.title
                              : vuln.title.length > 50
                                ? vuln.title.substring(0, 50) + '...'
                                : vuln.title}
                          </Text>
                          <Tag color={getSeverityColor(vuln.severity)}>
                            {vuln.severity.toUpperCase()}
                          </Tag>
                        </Space>
                        <Button
                          type='link'
                          size='small'
                          style={{
                            padding: 0,
                            height: 'auto',
                            fontSize: '10px',
                          }}
                          icon={
                            isExpanded(generateUniqueId(vuln, index)) ? (
                              <UpOutlined />
                            ) : (
                              <DownOutlined />
                            )
                          }
                          onClick={() =>
                            toggleExpanded(generateUniqueId(vuln, index))
                          }
                        />
                      </Space>
                    }
                    description={
                      isExpanded(generateUniqueId(vuln, index)) && (
                        <div>
                          <Text type='secondary' style={{ fontSize: '11px' }}>
                            {vuln.description}
                          </Text>
                          {vuln.file && (
                            <div style={{ marginTop: 4 }}>
                              <Text code style={{ fontSize: '10px' }}>
                                {vuln.file}:{vuln.line}
                              </Text>
                            </div>
                          )}
                        </div>
                      )
                    }
                  />
                </List.Item>
              )}
            />
          </div>
        )}
      </Space>
    </div>
  );

  const renderDASTContent = (dastData: DASTReport) => (
    <div>
      <Space direction='vertical' style={{ width: '100%' }} size='middle'>
        {/* Severity Breakdown */}
        <div>
          <Text strong style={{ marginBottom: 8, display: 'block' }}>
            심각도별 분포
          </Text>
          <Space wrap>
            <Tag color='red'>Critical: {dastData.criticalCount}</Tag>
            <Tag color='orange'>High: {dastData.highCount}</Tag>
            <Tag color='gold'>Medium: {dastData.mediumCount}</Tag>
            <Tag color='blue'>Low: {dastData.lowCount}</Tag>
          </Space>
        </div>

        {/* Vulnerabilities */}
        {dastData.vulnerabilities && dastData.vulnerabilities.length > 0 && (
          <div>
            <Text strong style={{ marginBottom: 8, display: 'block' }}>
              취약점 리스트
            </Text>
            <List
              size='small'
              dataSource={dastData.vulnerabilities}
              style={{ maxHeight: '400px', overflowY: 'auto' }}
              renderItem={(vuln: SecurityVulnerability, index: number) => (
                <List.Item>
                  <List.Item.Meta
                    avatar={getStatusIcon(vuln.status)}
                    title={
                      <Space
                        style={{
                          width: '100%',
                          justifyContent: 'space-between',
                        }}
                      >
                        <Space>
                          <Text
                            style={{ fontSize: '13px' }}
                            ellipsis={
                              isExpanded(generateUniqueId(vuln, index))
                                ? false
                                : {
                                    tooltip: vuln.title,
                                  }
                            }
                          >
                            {isExpanded(generateUniqueId(vuln, index))
                              ? vuln.title
                              : vuln.title.length > 50
                                ? vuln.title.substring(0, 50) + '...'
                                : vuln.title}
                          </Text>
                          <Tag color={getSeverityColor(vuln.severity)}>
                            {vuln.severity.toUpperCase()}
                          </Tag>
                        </Space>
                        <Button
                          type='link'
                          size='small'
                          style={{
                            padding: 0,
                            height: 'auto',
                            fontSize: '10px',
                          }}
                          icon={
                            isExpanded(generateUniqueId(vuln, index)) ? (
                              <UpOutlined />
                            ) : (
                              <DownOutlined />
                            )
                          }
                          onClick={() =>
                            toggleExpanded(generateUniqueId(vuln, index))
                          }
                        />
                      </Space>
                    }
                    description={
                      isExpanded(generateUniqueId(vuln, index)) && (
                        <div>
                          <Text type='secondary' style={{ fontSize: '11px' }}>
                            {vuln.description}
                          </Text>
                        </div>
                      )
                    }
                  />
                </List.Item>
              )}
            />
          </div>
        )}
      </Space>
    </div>
  );

  const renderSCAContent = (scaData: SASTReport) => (
    <div>
      <Space direction='vertical' style={{ width: '100%' }} size='middle'>
        {/* Severity Breakdown */}
        <div>
          <Text strong style={{ marginBottom: 8, display: 'block' }}>
            심각도별 분포
          </Text>
          <Space wrap>
            <Tag color='red'>Critical: {scaData.criticalCount}</Tag>
            <Tag color='orange'>High: {scaData.highCount}</Tag>
            <Tag color='gold'>Medium: {scaData.mediumCount}</Tag>
            <Tag color='blue'>Low: {scaData.lowCount}</Tag>
          </Space>
        </div>

        {/* SCA Vulnerabilities */}
        {scaData.vulnerabilities && scaData.vulnerabilities.length > 0 ? (
          <div>
            <Text strong style={{ marginBottom: 8, display: 'block' }}>
              취약점 리스트
            </Text>
            <List
              size='small'
              dataSource={scaData.vulnerabilities}
              style={{ maxHeight: '400px', overflowY: 'auto' }}
              renderItem={(vuln: SecurityVulnerability, index: number) => (
                <List.Item>
                  <List.Item.Meta
                    avatar={getStatusIcon(vuln.status)}
                    title={
                      <Space
                        style={{
                          width: '100%',
                          justifyContent: 'space-between',
                        }}
                      >
                        <Space>
                          <Text
                            style={{ fontSize: '13px' }}
                            ellipsis={
                              isExpanded(generateUniqueId(vuln, index))
                                ? false
                                : {
                                    tooltip: vuln.title,
                                  }
                            }
                          >
                            {isExpanded(generateUniqueId(vuln, index))
                              ? vuln.title
                              : vuln.title.length > 50
                                ? vuln.title.substring(0, 50) + '...'
                                : vuln.title}
                          </Text>
                          <Tag color={getSeverityColor(vuln.severity)}>
                            {vuln.severity.toUpperCase()}
                          </Tag>
                        </Space>
                        <Button
                          type='link'
                          size='small'
                          style={{
                            padding: 0,
                            height: 'auto',
                            fontSize: '10px',
                          }}
                          icon={
                            isExpanded(generateUniqueId(vuln, index)) ? (
                              <UpOutlined />
                            ) : (
                              <DownOutlined />
                            )
                          }
                          onClick={() =>
                            toggleExpanded(generateUniqueId(vuln, index))
                          }
                        />
                      </Space>
                    }
                    description={
                      isExpanded(generateUniqueId(vuln, index)) && (
                        <div>
                          <Text type='secondary' style={{ fontSize: '11px' }}>
                            {vuln.description}
                          </Text>
                        </div>
                      )
                    }
                  />
                </List.Item>
              )}
            />
          </div>
        ) : (
          <div style={{ textAlign: 'center', padding: '20px 0' }}>
            <CheckCircleOutlined
              style={{ fontSize: '32px', color: '#52c41a' }}
            />
            <div style={{ marginTop: 8 }}>
              <Text type='secondary'>활성 보안 알림이 없습니다</Text>
            </div>
          </div>
        )}
      </Space>
    </div>
  );

  const getIcon = () => {
    switch (type) {
      case 'sast':
        return <BugOutlined />;
      case 'dast':
        return <MonitorOutlined />;
      case 'sca':
        return <AlertOutlined />;
      default:
        return <BugOutlined />;
    }
  };

  const renderContent = () => {
    if (loading) {
      return (
        <div style={{ textAlign: 'center', padding: '40px 0' }}>
          <Text type='secondary'>데이터를 불러오는 중...</Text>
        </div>
      );
    }

    if (!data) {
      return (
        <div style={{ textAlign: 'center', padding: '40px 0' }}>
          <Text type='secondary'>데이터가 없습니다</Text>
        </div>
      );
    }

    switch (type) {
      case 'sast':
        return renderSASTContent(data as SASTReport);
      case 'dast':
        return renderDASTContent(data as DASTReport);
      case 'sca':
        return renderSCAContent(data as SASTReport);
      default:
        return null;
    }
  };

  return (
    <Card
      title={
        <Space>
          {getIcon()}
          {title}
        </Space>
      }
      size='small'
      style={{ height: '100%' }}
    >
      {renderContent()}
    </Card>
  );
};

export default SecurityVulnerabilityCard;
